
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>ETD Formulier</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
    button {
      background: #003b5c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
    }
    #bevestiging {
      display: none;
      padding: 1rem;
      background: #dff0d8;
      color: #3c763d;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body style="background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e7/Port_of_Rotterdam_Aerial.jpg/1920px-Port_of_Rotterdam_Aerial.jpg') no-repeat center center fixed; background-size: cover;">
  <div style="background-color: rgba(255, 255, 255, 0.85); border-radius: 16px; padding: 2rem; max-width: 600px; margin: 2rem auto;">
    <h2>ETD Invoeren</h2>
    <div id="bevestiging" style="display:none; padding:1rem; background:#dff0d8; color:#3c763d; border-radius:8px; margin-bottom:1rem;">
      ‚úîÔ∏è Inzending succesvol verzonden
    </div>

    <form id="etdForm">
      <label>Huidig schip (op loodsboot):</label>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div id="huidigSchipNaam">Detecteren...</div>
        <img id="vlaggetje" src="" alt="üá≥üá±" style="width: 24px; height: 16px; display: none;" />
      </div>

      <div style="margin-top:1rem;">
        <label>
          <input type="checkbox" id="anderSchip" /> Een ander schip kiezen
        </label>
        <input type="text" id="handmatigSchip" placeholder="Schipnaam invoeren" style="display:none;" list="schiplijst" />
        <datalist id="schiplijst"></datalist>
      </div>

      <div id="etdVeld" style="margin-top: 1rem;">
        <label>ETD:</label>
        <input type="datetime-local" id="etd" name="etd" />
      </div>

      <label style="margin-top: 1rem;">Reden indien geen ETD:</label>
      <select id="reden" name="reden">
        <option value="">-- Kies reden --</option>
        <option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
        <option value="Taal barri√®re">Taal barri√®re</option>
        <option value="Overig">Overig</option>
      </select>

      <label id="toelichtingLabel" style="display:none; margin-top: 1rem;">Toelichting (optioneel):</label>
      <textarea id="toelichting" name="toelichting" rows="4" style="display:none;"></textarea>

      <button type="submit" style="margin-top:1.5rem; padding: 0.75rem 1.5rem; border-radius: 8px; background: #003b5c; color: white; border: none; font-size: 1rem;">Verzenden</button>
    </form>
  </div>

  <script>
    document.getElementById("etdForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const naam = document.getElementById("anderSchip").checked
        ? document.getElementById("handmatigSchip").value
        : document.getElementById("huidigSchipNaam").textContent.trim();

      const data = {
        scheepsnaam: naam,
        etd: document.getElementById("etd")?.value || "",
        reden: document.getElementById("reden")?.value || "",
        toelichting: document.getElementById("toelichting")?.value || "",
        timestamp: new Date().toISOString()
      };

      const csv = [
        "Scheepsnaam,ETD,RedenGeenETD,Toelichting,Timestamp",
        `${data.scheepsnaam},${data.etd},${data.reden},${data.toelichting},${data.timestamp}`
      ].join("
");

      const res = await fetch("/api/verstuur", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ csv, onderwerp: `ETD Inzending, ${data.scheepsnaam}, ${data.timestamp}` })
      });

      if (res.ok) {
        document.getElementById("bevestiging").style.display = "block";
        document.getElementById("etdForm").reset();
        document.getElementById("vlaggetje").style.display = "none";
      } else {
        alert("‚ùå Fout bij verzenden");
      }
    });

    document.getElementById("reden").addEventListener("change", function () {
      const reden = this.value;
      document.getElementById("etdVeld").style.display = reden ? "none" : "block";
      const toel = document.getElementById("toelichting");
      const label = document.getElementById("toelichtingLabel");
      if (reden === "Overig") {
        toel.style.display = "block";
        label.style.display = "block";
      } else {
        toel.style.display = "none";
        label.style.display = "none";
      }
    });

    document.getElementById("anderSchip").addEventListener("change", function () {
      document.getElementById("handmatigSchip").style.display = this.checked ? "block" : "none";
    });

    async function detecteerSchip() {
      try {
        const geo = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );
        const lat = geo.coords.latitude;
        const lon = geo.coords.longitude;

        const res = await fetch("/api/schepen");
        const schepen = await res.json();

        const dichtbij = schepen.map(s => {
          const track = s.track || [];
          const laatst = track[track.length - 1];
          const d = Math.sqrt((lat - laatst.lat) ** 2 + (lon - laatst.lon) ** 2);
          return { naam: s.naam, mmsi: s.mmsi, afstand: d };
        }).sort((a, b) => a.afstand - b.afstand);

        const lijst = document.getElementById("schiplijst");
        lijst.innerHTML = "";
        dichtbij.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          lijst.appendChild(opt);
        });

        if (dichtbij.length > 0) {
          const schip = dichtbij[0];
          document.getElementById("huidigSchipNaam").textContent = schip.naam;

          const vlag = schip.mmsi?.toString().substring(0, 3);
          const landcode = vlagToISO(vlag);
          if (landcode) {
            const vlagurl = `https://flagcdn.com/24x18/${landcode}.png`;
            const vlagimg = document.getElementById("vlaggetje");
            vlagimg.src = vlagurl;
            vlagimg.style.display = "inline-block";
          }
        }
      } catch (err) {
        console.warn("Locatie of schepen niet beschikbaar:", err);
      }
    }

    function vlagToISO(mmsiprefix) {
      const m = {
        "205": "be", "206": "be", "244": "nl", "245": "nl", "246": "nl", "235": "gb",
        "219": "dk", "218": "dk", "227": "fr", "228": "fr", "213": "de", "211": "de",
        "310": "us", "311": "us", "316": "ca", "257": "no", "257": "no"
      };
      return m[mmsiprefix];
    }

    detecteerSchip();
  </script>
</body>

</html>
