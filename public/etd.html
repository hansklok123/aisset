<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ETD Formulier</title>
  <style>
    :root {
      --kleur-hoofd: #003b5c;
      --kleur-accent: #e0f7ff;
      --kleur-tekst: #002d44;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      background: var(--kleur-accent);
      color: var(--kleur-tekst);
      display: flex;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
    }

    h2 {
      color: var(--kleur-hoofd);
      margin-top: 0;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 1.5rem;
      font-weight: 600;
    }

    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
      box-sizing: border-box;
    }

    button {
      background: var(--kleur-hoofd);
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 2rem;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #005a87;
    }

    #bevestiging {
      display: none;
      padding: 1rem;
      background: #dff0d8;
      color: #3c763d;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }

    @media (max-width: 600px) {
      body {
        padding: 1rem 0.5rem;
      }

      .container {
        padding: 1rem;
        border-radius: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ETD Invoeren</h2>
    <div id="bevestiging">✔️ Inzending succesvol verzonden</div>

    <form id="etdForm">
      <label>Huidig schip (op loodsboot):
        <div id="huidigSchipNaam">Detecteren...</div>
      </label>

      <label>ETD:
        <input type="datetime-local" id="etd" name="etd" />
      </label>

      <label>Reden indien geen ETD:
        <select id="reden" name="reden">
          <option value="">-- Kies reden --</option>
          <option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
          <option value="Taal barrière">Taal barrière</option>
          <option value="Overig">Overig</option>
        </select>
      </label>

      <label>Toelichting (optioneel):
        <textarea id="toelichting" name="toelichting" rows="4"></textarea>
      </label>

      <button type="submit">Verzenden</button>
    </form>
  </div>

  <script>
    document.getElementById("etdForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const data = {
        scheepsnaam: document.getElementById("huidigSchipNaam").textContent.trim(),
        etd: document.getElementById("etd")?.value || "",
        reden: document.getElementById("reden")?.value || "",
        toelichting: document.getElementById("toelichting")?.value || "",
        timestamp: new Date().toISOString()
      };

      const csv = [
        "Scheepsnaam,ETD,RedenGeenETD,Toelichting,Timestamp",
        `${data.scheepsnaam},${data.etd},${data.reden},${data.toelichting},${data.timestamp}`
      ].join("\n");

      const onderwerp = data.etd ?
        `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}` :
        `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

      const res = await fetch("/api/verstuur", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ csv, onderwerp })
      });

      if (res.ok) {
        document.getElementById("bevestiging").style.display = "block";
      } else {
        alert("❌ Fout bij verzenden");
      }
    });

    async function detecteerSchip() {
      try {
        const geo = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );
        const lat = geo.coords.latitude;
        const lon = geo.coords.longitude;

        const res = await fetch("/api/schepen");
        const schepen = await res.json();
        const dichtbij = schepen.map(s => {
          const track = s.track || [];
          const laatst = track[track.length - 1];
          const d = Math.sqrt((lat - laatst.lat) ** 2 + (lon - laatst.lon) ** 2);
          return { naam: s.naam, afstand: d };
        }).sort((a, b) => a.afstand - b.afstand);

        if (dichtbij.length > 0) {
          document.getElementById("huidigSchipNaam").textContent = dichtbij[0].naam;
        }
      } catch (err) {
        console.warn("Kon locatie of schepen niet ophalen:", err);
      }
    }

    detecteerSchip();
  </script>
</body>
</html>
