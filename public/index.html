
<!DOCTYPE html>

<html lang="nl">
<head><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>ETD Formulier</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
    font-family: sans-serif;
    overflow-x: hidden;
}

.bg {
  position: fixed;
  z-index: -1;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw;
  height: 100vh;
  background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center;
  background-size: cover;
  animation: achtergrondFade 20s ease-in-out infinite alternate;
  pointer-events: none;
}

  @keyframes achtergrondFade {
    0% { filter: brightness(1); }
    100% { filter: brightness(0.95); }
  }

  form, .form-container, .etd-row, .etd-col {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
  }

  form {
    background-color: rgba(0, 0, 0, 0.65);
    padding: 1rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

 .form-container {
    max-width: 600px;
    margin: auto;
    padding: 0.2rem;
}

  .form-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .form-header img {
    max-height: 100px;
    margin-bottom: 0.2rem;
  }

  .form-header h2 {
    font-size: 1.5rem;
    color: #003b5c;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
    color: #003b5c;
  }

  input, select, textarea, button {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 0.75rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 0.5rem;
    background-color: rgba(255, 255, 255, 0.95);
    color: #000;
  }

  input[type="datetime-local"] {
    min-height: 48px;
    display: block;
  }

  button {
    background: #003b5c;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 1.5rem;
  }

  #bevestiging {
    display: none;
    padding: 1rem;
    background-color: rgba(200, 255, 200, 0.9);
    color: #003b5c;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .etd-row {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
  }

  .foutmelding {
    color: red;
    font-weight: bold;
    text-align: center;
    margin-top: 0.5rem;
  }

  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }

  .shake {
    animation: shake 0.3s;
  }

  /* Info-knop */
  .infobutton-page {
    position: fixed;
    top: 40px;
    right: 40px;
    width: 50px;
    background: none;
    border: none;
    padding: 0;
    z-index: 2022;
    cursor: pointer;
  }

  .info-circle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    background: #ededf0;
    color: #003b5c;
    font-size: 1.7rem;
    border-radius: 50%;
    font-weight: bold;
    border: 2px solid #bfc3cc;
    box-shadow: 0 2px 16px 0 #003b5c44;
  }

  .infobutton-page:active .info-circle,
  .infobutton-page:focus .info-circle {
    background: #2563eb;
    color: #fff;
  }


body, label, h2, .form-header h2 {
  color: #f8f9fa;
}

button {
  background-color: #85d678;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
  margin-top: 1.5rem;
}

#gpsButton {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  background: linear-gradient(to bottom right, #007bff, #66b3ff);
  color: white;
  font-weight: bold;
  cursor: pointer;
  margin-bottom: 1rem;
}

#gpsButton:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.5;
}

.toggle-switch-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 1.3rem;
  margin-top: 0.2rem;
}

#switchLabel {
  cursor: pointer;
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  background: #e5e7eb;
  border-radius: 20px;
  box-shadow: 0 2px 8px #0002;
  margin: 0 3px;
}

#switchDot {
  position: absolute;
  left: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: all 0.22s cubic-bezier(.8,.5,.2,1.4);
  box-shadow: 0 1px 4px #003b5c22;
}

input[type="checkbox"]#typeSwitch {
  display: none;
}

#binnenkomendLabel, #verhalendLabel {
  color: #f8f9fa;
}
</style>

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#003b5c" />

</head>
<body>
<div class="bg"></div>
  <script>
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
});
</script>
  

<div id="policyModal" style="display:none;position:fixed;z-index:3000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 18px 18px 18px;border-radius:18px;max-width:420px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;">
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Toestemmingsverklaring</h2>
    <div style="color:#28323c;font-size:1rem;max-height:180px;overflow:auto;margin-bottom:1rem;">
      <p>
        Door deze applicatie te gebruiken, geeft u toestemming voor het verwerken van uw gegevens voor onderzoeksdoeleinden.<br>
        Uw naam wordt uitsluitend gebruikt om uw toestemming vast te leggen en wordt niet gedeeld met derden.<br>
        Lees de <a href="#" id="showFullPrivacy" style="color:#2563eb;text-decoration:underline;">volledige informatie en privacyvoorwaarden</a> voor meer details.
      </p>
      <p>
        <b>Vul hieronder uw naam in om akkoord te gaan:</b>
      </p>
    </div>
    <input id="policyNameInput" type="text" placeholder="Uw naam" style="width:100%;padding:0.7rem;font-size:1rem;border-radius:8px;border:1px solid #ccc;margin-bottom:1rem;" />
    <div id="policyError" style="color:red;display:none;margin-bottom:0.5rem;">Vul uw naam in om akkoord te gaan.</div>
    <button id="policyAgreeBtn" style="background:#003b5c;color:#fff;padding:0.7rem 1.2rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer;width:100%;">Akkoord & Start</button>
  </div>
</div>

<!-- Uitgebreide privacy modal -->
<div id="fullPrivacyModal" style="display:none;position:fixed;z-index:4000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:18px 18px 18px 18px;padding-top:76px;border-radius:18px;max-width:540px;width:96vw;position:relative;box-shadow:0 4px 24px #003b5c33;max-height:90vh;overflow:auto;">
    <button id="closeFullPrivacy" type="button" style="position:absolute;top:10px;right:10px;font-size:28px;color:#003b5c;background:none;border:none;cursor:pointer;font-weight:bold;line-height:1;z-index:10;">&times;</button>
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Volledige informatie en privacyvoorwaarden</h2>
    <div style="color:#28323c;font-size:1rem;">
      <b>Toestemmingsverklaring voor gebruik van de ETD-webapplicatie</b><br><br>
      Deze webapplicatie is ontwikkeld voor het verzamelen van Estimated Time of Departure (ETD) van binnenkomende of verhalende schepen, zoals ingevoerd door loodsen. De ingevoerde gegevens worden gebruikt in het kader van een onderzoeksproject dat onderzoekt in hoeverre ETD-informatie bijdraagt aan een efficiÃ«ntere inzetplanning van loodsen in het gebied Rotterdam-Rijnmond.<br><br>
      <b>Doel van het onderzoek</b><br>
      Het doel van dit project is om te onderzoeken in welke mate de ETD-invoer door loodsen helpt bij het verbeteren van de betrouwbaarheid en efficiÃ«ntie van het planningsproces. Dit onderzoek wordt uitgevoerd in het kader van een afstudeerproject van de Maritieme Masteropleiding Pilotage, onder begeleiding van het Nederlands Loodswezen.<br><br>
      <b>Verwerking van gegevens</b><br>
      De ingevoerde gegevens worden niet gedeeld met derden.<br>
      Uw naam wordt uitsluitend opgeslagen om uw toestemming vast te leggen.<br>
      Alle andere gegevens worden anoniem verwerkt.<br>
      De data worden veilig opgeslagen volgens de richtlijnen van de Algemene Verordening Gegevensbescherming (AVG).<br>
      Geanonimiseerde gegevens kunnen worden gebruikt in rapportages en eventuele academische of professionele publicaties.<br><br>
      <b>Vrijwillige deelname</b><br>
      Het gebruik van deze applicatie is volledig vrijwillig. U kunt op elk moment stoppen met het invullen van gegevens. Als u eerder verzonden gegevens wilt laten verwijderen (zolang ze nog niet geanonimiseerd zijn), kunt u daar om verzoeken via onderstaande contactpersonen.<br><br>
      <b>Contact</b><br>
      Voor vragen over dit onderzoek kunt u contact opnemen met:
      Gijs Smit<br><br>
      <b>Toestemming</b><br>
      Door het formulier in te vullen en te verzenden, verklaart u dat:<br>
      - U deze informatie hebt gelezen en begrepen;<br>
      - U vrijwillig instemt met deelname aan dit project;<br>
      - U ten minste 18 jaar oud bent.
    </div>
  </div>
</div>

<script>
document.getElementById("showFullPrivacy").onclick = function(e) {
  e.preventDefault();
  document.getElementById("fullPrivacyModal").style.display = "flex";
};
document.getElementById("closeFullPrivacy").onclick = function() {
  document.getElementById("fullPrivacyModal").style.display = "none";
};
</script>

    <button id="infoButton" type="button" title="Meer informatie" class="infobutton-page">
  <span class="info-circle">i</span>
</button>
    
<div id="bevestiging">âœ”ï¸ Inzending succesvol verzonden</div>
<div class="form-container">

<div class="form-header">
<img alt="logo" src="https://hansklok123.github.io/aisset/logo.png"/>
</div>
<form id="etdForm">
<h2>ETD Invoeren</h2>
<label>Scheepsnaam:<select id="huidigSchipSelect" name="scheepsnaam"><option value="">Laden...</option></select></label><button id="gpsButton" onclick="forceerGPSLaad()" type="button">ğŸ“ Haal locatie op</button><div class="foutmelding" id="gpsFoutmelding"></div><label>Of typ handmatig de scheepsnaam:</label><input disabled="true" id="handmatigSchip" list="schiplijst" name="handmatig_scheepsnaam" placeholder="Begin met typen..." type="text"/>
<input type="hidden" id="hiddenHandmatigScheepsnaam" name="ScheepsnaamHandmatig"><datalist id="schiplijst"></datalist>

<div class="etd-row">
  <div class="etd-col etd-klein">
    <label for="etd">ETD:</label>
    <input id="etd" name="etd" type="datetime-local"/>
<div id="etdFoutmelding" style="display: none; color: red; font-weight: bold; margin-top: 0.2rem;">
  Vul eerst datum en geschatte tijd in
</div>
  </div>
  <div class="etd-col etd-groot">
    <label for="etdTijdvak">Vul in - indien tijd niet exact bekend:</label>
    <select id="etdTijdvak" name="etdTijdvak">
      <option value="">Tijdvak</option>
      <option value="00:00-06:00">Nacht 00:00 - 06:00</option>
      <option value="06:00-12:00">Ochtend 06:00 - 12:00</option>
      <option value="12:00-18:00">Middag 12:00 - 18:00</option>
      <option value="18:00-00:00">Avond 18:00 - 24:00</option>
    </select>
  </div>
</div>



<label>Reden indien geen ETD:
      <select id="reden" name="reden">
<option value="">-- Kies reden --</option>
<option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
<option value="Taal barriÃ¨re">Taal barriÃ¨re</option>
<option value="Overig">Overig</option>
</select>
</label>
<label>Toelichting (optioneel):
      <textarea id="toelichting" name="toelichting" rows="4"></textarea>
<label for="typeSwitch">Type (huidige) reis:</label>
<div class="toggle-switch-row">
  <span id="binnenkomendLabel">Binnenkomend</span>
  <input type="checkbox" id="typeSwitch" name="berichtType" style="display:none;">
  <label for="typeSwitch"
    id="switchLabel">
    <span id="switchDot"></span>
  </label>
  <span id="verhalendLabel">Verhalend</span>
  <input type="hidden" name="berichtTypeValue" id="berichtTypeValue" value="Binnenkomend">
</div>

</label>
<button type="submit">Verzenden</button>
</form></div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><script>
function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}
</script><script>
let laatstVerzonden = 0;

document.getElementById("reden").addEventListener("change", function () {
  const toelichting = document.getElementById("toelichting");
  if (this.value) {
    toelichting.removeAttribute("disabled");
  } else {
    toelichting.setAttribute("disabled", "true");
    toelichting.value = "";
  }
});

async function laadSchepen() {
  try {
    const geo = await new Promise((resolve, reject) =>
      navigator.geolocation.getCurrentPosition(resolve, reject)
    );
    const lat = geo.coords.latitude;
    const lon = geo.coords.longitude;

    const res = await fetch("/api/schepen");
    const schepen = await res.json();

    // Schepen verwerken en dropdown vullen:
const select = document.getElementById("huidigSchipSelect");
select.innerHTML = "";

const dichtbij = schepen
  .map(s => {
    const laatst = s.track?.[s.track.length - 1];
    if (!s.naam || !s.mmsi || !laatst) return null;
    const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
    return { naam: s.naam, mmsi: s.mmsi, afstand };
  })
  .filter(Boolean)
  .sort((a, b) => a.afstand - b.afstand)
  .slice(0, 15);

dichtbij.forEach((s, i) => {
  const opt = document.createElement("option");
  opt.value = s.naam;
  opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
  if (i === 0) opt.selected = true;
  select.appendChild(opt);
});

    // Eventueel: handmatig veld activeren
    document.getElementById("handmatigSchip").disabled = false;
    setSelectAndGPS(false);

  } catch (err) {
    // Controleer of het een locatie-fout is
    if (err && err.code !== undefined) {
      // Alleen bij locatie geweigerd of fout
      setSelectAndGPS(true);
      document.getElementById("gpsFoutmelding").innerText = "âš ï¸ Locatie niet toegestaan, vul handmatig in.";
      const handmatig = document.getElementById("handmatigSchip");
      handmatig.disabled = false;
      handmatig.focus();
    } else {
      // Andere fout (bijvoorbeeld fetch-fout)
      document.getElementById("gpsFoutmelding").innerText = "âš ï¸ Fout bij laden schepen, probeer later opnieuw.";
    }
    console.error("Fout bij laden schepen:", err);
  }
}

function afstandKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function landVlag(mmsi) {
  const landcodes = {
  "201": "ğŸ‡¦ğŸ‡±", "202": "ğŸ‡¦ğŸ‡©", "203": "ğŸ‡¦ğŸ‡¹", "204": "ğŸ‡µğŸ‡¹", "205": "ğŸ‡§ğŸ‡ª",
  "206": "ğŸ‡§ğŸ‡¾", "207": "ğŸ‡§ğŸ‡¬", "208": "ğŸ‡»ğŸ‡¦", "209": "ğŸ‡¨ğŸ‡¾", "210": "ğŸ‡¨ğŸ‡¿",
  "211": "ğŸ‡©ğŸ‡ª", "212": "ğŸ‡ªğŸ‡ª", "213": "ğŸ‡²ğŸ‡¹", "214": "ğŸ‡¬ğŸ‡·", "215": "ğŸ‡­ğŸ‡·",
  "216": "ğŸ‡®ğŸ‡¹", "218": "ğŸ‡®ğŸ‡ª", "219": "ğŸ‡®ğŸ‡¸", "220": "ğŸ‡®ğŸ‡¹", "224": "ğŸ‡±ğŸ‡»",
  "225": "ğŸ‡±ğŸ‡®", "226": "ğŸ‡±ğŸ‡¹", "227": "ğŸ‡±ğŸ‡º", "228": "ğŸ‡²ğŸ‡¨", "229": "ğŸ‡²ğŸ‡¹",
  "230": "ğŸ‡³ğŸ‡´", "231": "ğŸ‡µğŸ‡±", "232": "ğŸ‡¬ğŸ‡§", "233": "ğŸ‡¬ğŸ‡§", "234": "ğŸ‡¬ğŸ‡§",
  "235": "ğŸ‡¬ğŸ‡§", "236": "ğŸ‡¬ğŸ‡®", "237": "ğŸ‡¸ğŸ‡°", "238": "ğŸ‡¸ğŸ‡®", "239": "ğŸ‡ªğŸ‡¸",
  "240": "ğŸ‡¸ğŸ‡ª", "241": "ğŸ‡¨ğŸ‡­", "242": "ğŸ‡¨ğŸ‡¿", "243": "ğŸ‡­ğŸ‡º", "244": "ğŸ‡³ğŸ‡±",
  "245": "ğŸ‡³ğŸ‡±", "246": "ğŸ‡³ğŸ‡±", "247": "ğŸ‡¸ğŸ‡²", "248": "ğŸ‡»ğŸ‡¦", "249": "ğŸ‡²ğŸ‡¹",
  "250": "ğŸ‡¬ğŸ‡³", "251": "ğŸ‡²ğŸ‡°", "252": "ğŸ‡²ğŸ‡¨", "253": "ğŸ‡¸ğŸ‡°", "254": "ğŸ‡¸ğŸ‡®",
  "255": "ğŸ‡µğŸ‡¹", "301": "ğŸ‡©ğŸ‡ª", "302": "ğŸ‡±ğŸ‡º", "303": "ğŸ‡ºğŸ‡¸", "304": "ğŸ‡§ğŸ‡²",
  "305": "ğŸ‡¨ğŸ‡¦", "306": "ğŸ‡¸ğŸ‡½", "307": "ğŸ‡¨ğŸ‡¼", "308": "ğŸ‡§ğŸ‡¸", "309": "ğŸ‡«ğŸ‡´",
  "310": "ğŸ‡¦ğŸ‡¬", "311": "ğŸ‡§ğŸ‡§", "312": "ğŸ‡§ğŸ‡¿", "314": "ğŸ‡©ğŸ‡²", "316": "ğŸ‡¨ğŸ‡¦",
  "319": "ğŸ‡¯ğŸ‡²", "321": "ğŸ‡»ğŸ‡¨", "323": "ğŸ‡»ğŸ‡ª", "325": "ğŸ‡¸ğŸ‡·", "327": "ğŸ‡²ğŸ‡¸",
  "329": "ğŸ‡¹ğŸ‡¹", "330": "ğŸ‡¬ğŸ‡©", "331": "ğŸ‡°ğŸ‡³", "332": "ğŸ‡±ğŸ‡¨", "334": "ğŸ‡²ğŸ‡½",
  "338": "ğŸ‡ºğŸ‡¸", "339": "ğŸ‡ºğŸ‡¸", "341": "ğŸ‡µğŸ‡¦", "343": "ğŸ‡§ğŸ‡·", "345": "ğŸ‡°ğŸ‡¾",
  "348": "ğŸ‡»ğŸ‡®", "350": "ğŸ‡¬ğŸ‡¹", "351": "ğŸ‡¸ğŸ‡»", "352": "ğŸ‡­ğŸ‡³", "353": "ğŸ‡³ğŸ‡®",
  "354": "ğŸ‡¨ğŸ‡·", "355": "ğŸ‡µğŸ‡¦", "356": "ğŸ‡µğŸ‡ª", "357": "ğŸ‡¦ğŸ‡·", "358": "ğŸ‡¨ğŸ‡±",
  "359": "ğŸ‡¨ğŸ‡´", "361": "ğŸ‡»ğŸ‡ª", "362": "ğŸ‡ºğŸ‡¾", "364": "ğŸ‡µğŸ‡¾", "366": "ğŸ‡ºğŸ‡¸",
  "371": "ğŸ‡µğŸ‡¦", "372": "ğŸ‡ªğŸ‡¨", "373": "ğŸ‡§ğŸ‡´", "375": "ğŸ‡»ğŸ‡ª", "376": "ğŸ‡¬ğŸ‡¹",
  "400": "ğŸ‡¦ğŸ‡º", "401": "ğŸ‡®ğŸ‡©", "403": "ğŸ‡®ğŸ‡³", "405": "ğŸ‡°ğŸ‡·", "408": "ğŸ‡¯ğŸ‡µ",
  "412": "ğŸ‡¨ğŸ‡³", "413": "ğŸ‡¨ğŸ‡³", "414": "ğŸ‡¨ğŸ‡³", "416": "ğŸ‡¹ğŸ‡¼", "417": "ğŸ‡°ğŸ‡µ",
  "419": "ğŸ‡®ğŸ‡³", "422": "ğŸ‡®ğŸ‡±", "423": "ğŸ‡®ğŸ‡·", "424": "ğŸ‡°ğŸ‡¿", "425": "ğŸ‡·ğŸ‡º",
  "428": "ğŸ‡¸ğŸ‡¦", "431": "ğŸ‡¸ğŸ‡¬", "432": "ğŸ‡¹ğŸ‡­", "434": "ğŸ‡¹ğŸ‡·", "436": "ğŸ‡ºğŸ‡¿",
  "437": "ğŸ‡»ğŸ‡³", "440": "ğŸ‡°ğŸ‡·", "441": "ğŸ‡¯ğŸ‡µ", "443": "ğŸ‡²ğŸ‡¾", "445": "ğŸ‡µğŸ‡­",
  "447": "ğŸ‡°ğŸ‡µ", "450": "ğŸ‡§ğŸ‡©", "451": "ğŸ‡°ğŸ‡­", "453": "ğŸ‡±ğŸ‡¦", "455": "ğŸ‡²ğŸ‡²",
  "457": "ğŸ‡µğŸ‡°", "459": "ğŸ‡±ğŸ‡°", "501": "ğŸ‡¦ğŸ‡º", "503": "ğŸ‡¦ğŸ‡º", "506": "ğŸ‡³ğŸ‡¿",
  "508": "ğŸ‡µğŸ‡¬", "510": "ğŸ‡«ğŸ‡¯", "511": "ğŸ‡²ğŸ‡­", "512": "ğŸ‡³ğŸ‡·", "513": "ğŸ‡³ğŸ‡¿",
  "514": "ğŸ‡¹ğŸ‡´", "515": "ğŸ‡¹ğŸ‡»", "516": "ğŸ‡¼ğŸ‡¸", "518": "ğŸ‡»ğŸ‡º", "601": "ğŸ‡¿ğŸ‡¦",
  "603": "ğŸ‡¦ğŸ‡´", "605": "ğŸ‡§ğŸ‡®", "607": "ğŸ‡¨ğŸ‡²", "608": "ğŸ‡¨ğŸ‡»", "609": "ğŸ‡¨ğŸ‡«",
  "610": "ğŸ‡¨ğŸ‡¬", "611": "ğŸ‡¨ğŸ‡©", "612": "ğŸ‡§ğŸ‡¯", "613": "ğŸ‡¬ğŸ‡¦", "615": "ğŸ‡¬ğŸ‡²",
  "616": "ğŸ‡¬ğŸ‡³", "617": "ğŸ‡¨ğŸ‡®", "618": "ğŸ‡°ğŸ‡ª", "619": "ğŸ‡±ğŸ‡·", "620": "ğŸ‡²ğŸ‡¬",
  "621": "ğŸ‡²ğŸ‡¼", "622": "ğŸ‡²ğŸ‡±", "624": "ğŸ‡²ğŸ‡·", "625": "ğŸ‡²ğŸ‡¿", "626": "ğŸ‡³ğŸ‡¦",
  "627": "ğŸ‡³ğŸ‡ª", "628": "ğŸ‡³ğŸ‡¬", "630": "ğŸ‡¸ğŸ‡¹", "631": "ğŸ‡¸ğŸ‡³", "632": "ğŸ‡¸ğŸ‡¨",
  "633": "ğŸ‡¸ğŸ‡±", "634": "ğŸ‡¸ğŸ‡´", "635": "ğŸ‡¿ğŸ‡¦", "636": "ğŸ‡¸ğŸ‡©", "637": "ğŸ‡¸ğŸ‡¿",
  "638": "ğŸ‡¹ğŸ‡¿", "639": "ğŸ‡¹ğŸ‡¬", "640": "ğŸ‡¹ğŸ‡³", "641": "ğŸ‡ºğŸ‡¬", "642": "ğŸ‡¿ğŸ‡²",
  "643": "ğŸ‡¿ğŸ‡¼", "645": "ğŸ‡ªğŸ‡·", "647": "ğŸ‡ªğŸ‡¹", "649": "ğŸ‡²ğŸ‡º", "650": "ğŸ‡¸ğŸ‡­"
}
;
  return landcodes[mmsi?.toString().substring(0, 3)] || "ğŸ³ï¸";
}

document.getElementById("etdForm").addEventListener("submit", async function (e) {
    
    // Vul de hidden input altijd met de handmatige waarde
    document.getElementById("hiddenHandmatigScheepsnaam").value = manualField.value || "";

  e.preventDefault();

  const nu = Date.now();
  const tijdSindsLaatste = nu - laatstVerzonden;

  const etdField = document.getElementById("etd");
  const redenField = document.getElementById("reden");
  const etd = etdField.value.trim();
  const reden = redenField.value.trim();
  const tijdvak = document.getElementById("etdTijdvak").value;
  const etdWaarde = tijdvak ? `${etd} (E:${tijdvak})` : etd;

  // Reset borders
  etdField.style.border = "";
  redenField.style.border = "";

  // Controleer of het formulier geldig is (ETD of reden vereist)
  if (!etd && !reden) {
    etdField.style.border = "2px solid red";
    redenField.style.border = "2px solid red";
    return;
  }

  // Controleer throttle alleen bij geldig formulier
  if (tijdSindsLaatste < 60000) {
    alert("Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.");
    return;
  }





const data = {
  scheepsnaam: document.getElementById("huidigSchipSelect").value,
  scheepsnaamHandmatig: document.getElementById("handmatigSchip").value,
  etd: etdWaarde,
  reden,
  toelichting: document.getElementById("toelichting").value.trim(),
  Status: document.getElementById('berichtTypeValue').value,
  timestamp: new Date().toISOString(),naam: localStorage.getItem("userName") || ""   // <-- voeg deze regel toe
};


 function escapeCSV(value) {
  if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
    return `"${value.replace(/"/g, '""')}"`; // escape dubbele quotes
  }
  return value;
}

const csv = `Scheepsnaam,ScheepsnaamHandmatig,ETD,RedenGeenETD,Toelichting,Status,Type_naam,Lengte,Timestamp,Latitude,Longitude,Naam\n` +
  `${escapeCSV(data.scheepsnaam)},${escapeCSV(data.scheepsnaamHandmatig)},${escapeCSV(data.etd)},` +
  `${escapeCSV(data.reden)},${escapeCSV(data.toelichting)},${escapeCSV(data.Status)},,,${escapeCSV(data.timestamp)},,,${escapeCSV(localStorage.getItem("userName") || "")}`;


  const onderwerp = data.etd ?
    `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}` :
    `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

  const res = await fetch("/api/verstuur", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv, onderwerp })
  });

  if (res.ok) {
    laatstVerzonden = Date.now();
    document.getElementById("bevestiging").style.display = "block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
  setTimeout(() => {
    location.reload();
  }, 30000); // herlaad na 30 seconden

    vuurConfettiSerie();
  } else {
    alert("âŒ Fout bij verzenden");
  }
});

function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();
    if (timeLeft <= 0) return clearInterval(interval);

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}




async function vulAutoAan() {
  try {
    const res = await fetch("/api/schepen");
    const schepen = await res.json();
    const lijst = document.getElementById("schiplijst");
    lijst.innerHTML = "";
    schepen.forEach(s => {
      if (s.naam) {
        const opt = document.createElement("option");
        opt.value = s.naam;
        lijst.appendChild(opt);
      }
    });
  } catch (err) {
    console.error("Auto-aanvul fout:", err);
  }
}

document.getElementById("handmatigSchip").addEventListener("input", function () {
  document.getElementById("huidigSchipSelect").value = ""; // reset dropdown keuze
});


</script><script>
function forceerGPSLaad() {
  navigator.geolocation.getCurrentPosition(
    async (geo) => {
      const lat = geo.coords.latitude;
      const lon = geo.coords.longitude;

      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();

        const dichtbij = schepen
          .map(s => {
            const laatst = s.track?.[s.track.length - 1];
            if (!s.naam || !s.mmsi || !laatst) return null;
            const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
            return { naam: s.naam, mmsi: s.mmsi, afstand };
          })
          .filter(Boolean)
          .sort((a, b) => a.afstand - b.afstand)
          .slice(0, 15);

        const select = document.getElementById("huidigSchipSelect");
        select.innerHTML = "";

        dichtbij.forEach((s, i) => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
          if (i === 0) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("GPS refresh fout:", err);
      }
    },
    (err) => {
      alert("Kon GPS-locatie niet ophalen: " + err.message);
    }
  );
}
</script><script>
// IDs van velden
const selectField = document.getElementById("huidigSchipSelect");
const manualField = document.getElementById("handmatigSchip");
const gpsButton = document.getElementById("gpsButton");

// Helper om select en gps (de)activeren en transparantie zetten
function setSelectAndGPS(disabled) {
    selectField.disabled = disabled;
    gpsButton.disabled = disabled;
    selectField.style.opacity = disabled ? "0.5" : "1";
    gpsButton.style.opacity = disabled ? "0.5" : "1";
}

// Direct na laden: handmatige veld altijd actief
window.addEventListener("DOMContentLoaded", function() {
    if (manualField) manualField.disabled = false;
    setSelectAndGPS(false);


});

// Wanneer je in het handmatige veld typt
manualField && manualField.addEventListener("input", function() {
    if (manualField.value.trim() !== "") {
        setSelectAndGPS(true);
        selectField.value = "";
    } else {
        // Alleen weer activeren als er wÃ©l schepen geladen zijn (dus niet als nog 'Laden...')
        if (selectField && (!selectField.options.length || !selectField.options[0].textContent.includes('Laden'))) {
            setSelectAndGPS(false);
        }
    }
});

// Zorg dat handmatige veld zijn datalist-link houdt
if (manualField) manualField.disabled = false;

</script>

<script>
document.getElementById("etdTijdvak").addEventListener("change", function () {
  const tijdvak = this.value;
  const etdField = document.getElementById("etd");
  const foutmelding = document.getElementById("etdFoutmelding");

  if (tijdvak && !etdField.value.trim()) {
    // Reset selectie terug naar beginoptie
    this.value = "";

    // Toon foutmelding + rode rand + shake
    etdField.style.border = "2px solid red";
    etdField.classList.add("shake");
    foutmelding.style.display = "block";

    // Shake stoppen
    setTimeout(() => etdField.classList.remove("shake"), 2000);

    // Verwijder foutmelding na 4s
    setTimeout(() => {
      foutmelding.style.display = "none";
      etdField.style.border = "";
    }, 4000);

    // Probeer picker te openen op niet-iOS
    setTimeout(() => {
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) || 
                    (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

      if (!isIOS) {
        etdField.blur();
        setTimeout(() => {
          etdField.focus();
          if (etdField.showPicker) etdField.showPicker();
        }, 200);
      }
    }, 50);
  }
});
</script>



<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('âœ… Service Worker geregistreerd:', reg.scope))
        .catch(err => console.warn('âŒ Service Worker fout:', err));
    });
  }
</script>


<script>
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      location.reload();
    }
  });
</script>


<div id="infoModal"
     style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.38);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:24px 18px 16px 18px;border-radius:18px;max-width:400px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;">
    <button id="closeModal" type="button"
            style="position:absolute;top:10px;right: -150px;font-size:22px;color:#003b5c;background:none;border:none;cursor:pointer;font-weight:bold;line-height:1;">&times;</button>
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Informatie</h2>
    <p style="color:#28323c;">
      Deze app is onderdeel van een MMP14-onderzoek en onderzoekt
    de waarde van het opvragen van de ETD bij de kapitein van een binnenkomend of verhalend schip.<br><br>
      Scheepsnaam wordt doormiddel van GPS locatie automatisch gezocht.
      Mocht de voorgestelde scheepsnaam niet kloppen dan kan hij handmatig ingevuld worden. <br><br>
      
      Check: <b>Scheepsnaam, ETD of Reden geen ETD, Type reis: Binnenkomend of Verhalend.</b><br><br>
      Bedankt voor uw bijdrage!
    </p>
  </div>
</div>


<script>
  // Info popup
  document.getElementById('infoButton').onclick = function(e) {
    e.preventDefault();
    document.getElementById('infoModal').style.display = 'flex';
  };
  document.getElementById('closeModal').onclick = function() {
    document.getElementById('infoModal').style.display = 'none';
  };
  // Toggle switch
  const typeSwitch = document.getElementById('typeSwitch');
  const switchDot = document.getElementById('switchDot');
  const berichtTypeValue = document.getElementById('berichtTypeValue');
  const verhalendLabel = document.getElementById('verhalendLabel');
  const binnenkomendLabel = document.getElementById('binnenkomendLabel');
  function updateToggleUI() {
    if(typeSwitch.checked) {
      switchDot.style.left = '22px';
      berichtTypeValue.value = 'Verhalend';
      verhalendLabel.style.fontWeight = 'bold';
      verhalendLabel.style.color = '#85d678';
      binnenkomendLabel.style.color = '#f8f9fa';
      binnenkomendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '.5';
      verhalendLabel.style.opacity = '1';
    
    } else {
      switchDot.style.left = '2px';
      berichtTypeValue.value = 'Binnenkomend';
      binnenkomendLabel.style.fontWeight = 'bold';
      binnenkomendLabel.style.color = '#85d678';
      verhalendLabel.style.color = '#f8f9fa';
      verhalendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '1';
      verhalendLabel.style.opacity = '.5';
    }
  }
  typeSwitch.onchange = updateToggleUI;
  updateToggleUI();
</script>
<script>
(function() {
  const agreed = localStorage.getItem("policyAgreed");
  const modal = document.getElementById("policyModal");
  const agreeBtn = document.getElementById("policyAgreeBtn");
  const nameInput = document.getElementById("policyNameInput");
  const errorDiv = document.getElementById("policyError");
  const form = document.getElementById("etdForm");
  const params = new URLSearchParams(window.location.search);

  function showModal() {
    modal.style.display = "flex";
    if (form) form.style.filter = "blur(2px)";
    document.body.style.overflow = "hidden";
  }
  function hideModal() {
    modal.style.display = "none";
    if (form) form.style.filter = "";
    document.body.style.overflow = "";
  }

  function startNaAkkoord() {
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = false);
    laadSchepen();
    if (typeof vulAutoAan === "function") vulAutoAan();
  }

  
  if (!agreed && !params.get("consent")) {
    showModal();
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);

    agreeBtn.onclick = async function() {
      const name = nameInput.value.trim();
      if (!name) {
        errorDiv.style.display = "block";
        return;
      }
      localStorage.setItem("policyAgreed", "1");
      localStorage.setItem("userName", name);
      hideModal();
      startNaAkkoord();
      await new Promise(r => setTimeout(r, 100));

      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      }
      location.reload();
    };
  } else if (!params.get("consent")) {
  
    startNaAkkoord();
  }
})();

(function() {
  const params = new URLSearchParams(window.location.search);
  const showFullPrivacy = params.get("consent") === "1";
  const fullPrivacyModal = document.getElementById("fullPrivacyModal");
  const policyModal = document.getElementById("policyModal");
  const form = document.getElementById("etdForm");

  if (showFullPrivacy) {
    fullPrivacyModal.style.display = "flex";
    policyModal.style.display = "none";
    if (form) form.style.filter = "blur(2px)";
    document.body.style.overflow = "hidden";
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);
  }
})();
</script>

</body>
</html>
