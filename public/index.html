
<!DOCTYPE html>

<html lang="nl">
<head><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>ETD Formulier</title>
<style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
    button {
      background: #003b5c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
    }
    #bevestiging {
      display: none;
      padding: 1rem;
      background: #dff0d8;
      color: #3c763d;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
  
    body {
      background: url('https://storage.rotterdammaritimecapital.com/storage/2018/08/01152337/RMCOE_Port-and-Logistics.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }

    form {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      border-radius: 1rem;
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    
    body {
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    @keyframes achtergrondFade {
      0%   { filter: brightness(1); }
      100% { filter: brightness(0.95); }
    }

    form {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
      padding: 1rem;
      border-radius: 1rem;
      backdrop-filter: blur(4px);
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    

    .form-container {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.8);
      border-radius: 0.1rem;
      padding: 0.1rem;
      backdrop-filter: blur(6px);
      max-width: 600px;
      margin: auto;
    }

    .form-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-header img {
      max-height: 100px;
      margin-bottom: 0.2rem;
    }

    .form-header h2 {
      color: white;
      margin: 0;
      font-size: 1.5rem;
    }
    

    .form-header h2 {
      color: #003b5c;
    }

    label {
      color: #003b5c;
    }

    #bevestiging {
      background-color: rgba(200, 255, 200, 0.9);
      color: #003b5c;
    }

    button {
      background-color: #85d678;
      color: white;
    }
    

    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    button {
      width: 100%;
      margin-top: 1rem;
    }
    
    
    body, label, h2 {
      color: #f8f9fa;
    }

    input, textarea, select {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
      border: 1px solid #ccc;
    }

    select option {
      color: #000;
      background-color: #fff;
    }
    
    .form-container {
      background-color: rgba(255, 255, 255, 0.7); /* 70% opaque wit */
      box-shadow: none; /* verwijder donkere rand */
      backdrop-filter: blur(10px);
    }
    
    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    input, select, textarea {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }
    
    body {
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }
    
    #gpsButton {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background: linear-gradient(to bottom right, #007bff, #66b3ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    #gpsButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    select:disabled, #gpsButton:disabled {
      opacity: 0.5;
    }
    
    .foutmelding {
      color: red;
      font-weight: bold;
      text-align: center;
      margin-top: 0.5rem;
    }

    #handmatigSchip {
      opacity: 0.5;
    }

    #handmatigSchip:enabled {
      opacity: 1;
    }
    

.toggle-switch-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 1.3rem;
  margin-top: 0.2rem;
}
#switchLabel {
  cursor: pointer;
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  background: #e5e7eb;
  border-radius: 20px;
  box-shadow: 0 2px 8px #0002;
  margin: 0 3px;
}
#switchDot {
  position: absolute;
  left: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: all 0.22s cubic-bezier(.8,.5,.2,1.4);
  box-shadow: 0 1px 4px #003b5c22;
}
input[type="checkbox"]#typeSwitch {
  display: none;
}

.infobutton-page {
  position: fixed;
  top: 40px;
  right: 40px;
  width: 50px;
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  z-index: 2022;
  cursor: pointer;
}

.info-circle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  background: #ededf0;
  color: #003b5c;
  font-size: 1.7rem;
  font-family: Arial, sans-serif;
  border-radius: 50%;
  font-weight: bold;
  box-shadow: 0 2px 16px 0 #003b5c44;
  user-select: none;
  border: 2px solid #bfc3cc;
  transition: background 0.13s, color 0.13s;
}
    .infobutton-page:active .info-circle,
.infobutton-page:focus .info-circle {
  background: #2563eb;
  color: #fff;
  outline: none;
}

</style>

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#003b5c" />

</head>
<body>
    <button id="infoButton" type="button" title="Meer informatie" class="infobutton-page">
  <span class="info-circle">i</span>
</button>
    
<div id="bevestiging">âœ”ï¸ Inzending succesvol verzonden</div>
<div class="form-container">

<div class="form-header">
<img alt="logo" src="https://hansklok123.github.io/aisset/logo.png"/>
</div>
<form id="etdForm">
<h2>ETD Invoeren</h2>
<label>Scheepsnaam:<select id="huidigSchipSelect" name="scheepsnaam"><option value="">Laden...</option></select></label><button id="gpsButton" onclick="forceerGPSLaad()" type="button">ğŸ“ Haal locatie op</button><div class="foutmelding" id="gpsFoutmelding"></div><label>Of typ handmatig de scheepsnaam:</label><input disabled="true" id="handmatigSchip" list="schiplijst" name="handmatig_scheepsnaam" placeholder="Begin met typen..." type="text"/>
<input type="hidden" id="hiddenHandmatigScheepsnaam" name="ScheepsnaamHandmatig"><datalist id="schiplijst"></datalist><label>ETD:
      <input id="etd" name="etd" type="datetime-local"/>
</label>
<label>Reden indien geen ETD:
      <select id="reden" name="reden">
<option value="">-- Kies reden --</option>
<option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
<option value="Taal barriÃ¨re">Taal barriÃ¨re</option>
<option value="Overig">Overig</option>
</select>
</label>
<label>Toelichting (optioneel):
      <textarea id="toelichting" name="toelichting" rows="4"></textarea>
<label for="typeSwitch">Type reis gevraagd:</label>
<div class="toggle-switch-row">
  <span id="binnenkomendLabel">Binnenkomend</span>
  <input type="checkbox" id="typeSwitch" name="berichtType" style="display:none;">
  <label for="typeSwitch"
    id="switchLabel">
    <span id="switchDot"></span>
  </label>
  <span id="verhalendLabel">Verhalend</span>
  <input type="hidden" name="berichtTypeValue" id="berichtTypeValue" value="Binnenkomend">
</div>

</label>
<button type="submit">Verzenden</button>
</form></div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><script>
function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}
</script><script>
let laatstVerzonden = 0;

document.getElementById("reden").addEventListener("change", function () {
  const toelichting = document.getElementById("toelichting");
  if (this.value) {
    toelichting.removeAttribute("disabled");
  } else {
    toelichting.setAttribute("disabled", "true");
    toelichting.value = "";
  }
});

async function laadSchepen() {
  try {
    const geo = await new Promise((resolve, reject) =>
      navigator.geolocation.getCurrentPosition(resolve, reject)
    );
    const lat = geo.coords.latitude;
    const lon = geo.coords.longitude;

    const res = await fetch("/api/schepen");
    const schepen = await res.json();

    const dichtbij = schepen
      .map(s => {
        const laatst = s.track?.[s.track.length - 1];
        if (!s.naam || !s.mmsi || !laatst) return null;
        const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
        return { naam: s.naam, mmsi: s.mmsi, afstand };
      })
      .filter(Boolean)
      .sort((a, b) => a.afstand - b.afstand)
      .slice(0, 15);

    const select = document.getElementById("huidigSchipSelect");
    select.innerHTML = "";

    dichtbij.forEach((s, i) => {
      const opt = document.createElement("option");
      opt.value = s.naam;
      opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
      if (i === 0) opt.selected = true;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error("Fout bij laden schepen:", err);
  }
}

function afstandKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function landVlag(mmsi) {
  const landcodes = {
  "201": "ğŸ‡¦ğŸ‡±", "202": "ğŸ‡¦ğŸ‡©", "203": "ğŸ‡¦ğŸ‡¹", "204": "ğŸ‡µğŸ‡¹", "205": "ğŸ‡§ğŸ‡ª",
  "206": "ğŸ‡§ğŸ‡¾", "207": "ğŸ‡§ğŸ‡¬", "208": "ğŸ‡»ğŸ‡¦", "209": "ğŸ‡¨ğŸ‡¾", "210": "ğŸ‡¨ğŸ‡¿",
  "211": "ğŸ‡©ğŸ‡ª", "212": "ğŸ‡ªğŸ‡ª", "213": "ğŸ‡²ğŸ‡¹", "214": "ğŸ‡¬ğŸ‡·", "215": "ğŸ‡­ğŸ‡·",
  "216": "ğŸ‡®ğŸ‡¹", "218": "ğŸ‡®ğŸ‡ª", "219": "ğŸ‡®ğŸ‡¸", "220": "ğŸ‡®ğŸ‡¹", "224": "ğŸ‡±ğŸ‡»",
  "225": "ğŸ‡±ğŸ‡®", "226": "ğŸ‡±ğŸ‡¹", "227": "ğŸ‡±ğŸ‡º", "228": "ğŸ‡²ğŸ‡¨", "229": "ğŸ‡²ğŸ‡¹",
  "230": "ğŸ‡³ğŸ‡´", "231": "ğŸ‡µğŸ‡±", "232": "ğŸ‡¬ğŸ‡§", "233": "ğŸ‡¬ğŸ‡§", "234": "ğŸ‡¬ğŸ‡§",
  "235": "ğŸ‡¬ğŸ‡§", "236": "ğŸ‡¬ğŸ‡®", "237": "ğŸ‡¸ğŸ‡°", "238": "ğŸ‡¸ğŸ‡®", "239": "ğŸ‡ªğŸ‡¸",
  "240": "ğŸ‡¸ğŸ‡ª", "241": "ğŸ‡¨ğŸ‡­", "242": "ğŸ‡¨ğŸ‡¿", "243": "ğŸ‡­ğŸ‡º", "244": "ğŸ‡³ğŸ‡±",
  "245": "ğŸ‡³ğŸ‡±", "246": "ğŸ‡³ğŸ‡±", "247": "ğŸ‡¸ğŸ‡²", "248": "ğŸ‡»ğŸ‡¦", "249": "ğŸ‡²ğŸ‡¹",
  "250": "ğŸ‡¬ğŸ‡³", "251": "ğŸ‡²ğŸ‡°", "252": "ğŸ‡²ğŸ‡¨", "253": "ğŸ‡¸ğŸ‡°", "254": "ğŸ‡¸ğŸ‡®",
  "255": "ğŸ‡µğŸ‡¹", "301": "ğŸ‡©ğŸ‡ª", "302": "ğŸ‡±ğŸ‡º", "303": "ğŸ‡ºğŸ‡¸", "304": "ğŸ‡§ğŸ‡²",
  "305": "ğŸ‡¨ğŸ‡¦", "306": "ğŸ‡¸ğŸ‡½", "307": "ğŸ‡¨ğŸ‡¼", "308": "ğŸ‡§ğŸ‡¸", "309": "ğŸ‡«ğŸ‡´",
  "310": "ğŸ‡¦ğŸ‡¬", "311": "ğŸ‡§ğŸ‡§", "312": "ğŸ‡§ğŸ‡¿", "314": "ğŸ‡©ğŸ‡²", "316": "ğŸ‡¨ğŸ‡¦",
  "319": "ğŸ‡¯ğŸ‡²", "321": "ğŸ‡»ğŸ‡¨", "323": "ğŸ‡»ğŸ‡ª", "325": "ğŸ‡¸ğŸ‡·", "327": "ğŸ‡²ğŸ‡¸",
  "329": "ğŸ‡¹ğŸ‡¹", "330": "ğŸ‡¬ğŸ‡©", "331": "ğŸ‡°ğŸ‡³", "332": "ğŸ‡±ğŸ‡¨", "334": "ğŸ‡²ğŸ‡½",
  "338": "ğŸ‡ºğŸ‡¸", "339": "ğŸ‡ºğŸ‡¸", "341": "ğŸ‡µğŸ‡¦", "343": "ğŸ‡§ğŸ‡·", "345": "ğŸ‡°ğŸ‡¾",
  "348": "ğŸ‡»ğŸ‡®", "350": "ğŸ‡¬ğŸ‡¹", "351": "ğŸ‡¸ğŸ‡»", "352": "ğŸ‡­ğŸ‡³", "353": "ğŸ‡³ğŸ‡®",
  "354": "ğŸ‡¨ğŸ‡·", "355": "ğŸ‡µğŸ‡¦", "356": "ğŸ‡µğŸ‡ª", "357": "ğŸ‡¦ğŸ‡·", "358": "ğŸ‡¨ğŸ‡±",
  "359": "ğŸ‡¨ğŸ‡´", "361": "ğŸ‡»ğŸ‡ª", "362": "ğŸ‡ºğŸ‡¾", "364": "ğŸ‡µğŸ‡¾", "366": "ğŸ‡ºğŸ‡¸",
  "371": "ğŸ‡µğŸ‡¦", "372": "ğŸ‡ªğŸ‡¨", "373": "ğŸ‡§ğŸ‡´", "375": "ğŸ‡»ğŸ‡ª", "376": "ğŸ‡¬ğŸ‡¹",
  "400": "ğŸ‡¦ğŸ‡º", "401": "ğŸ‡®ğŸ‡©", "403": "ğŸ‡®ğŸ‡³", "405": "ğŸ‡°ğŸ‡·", "408": "ğŸ‡¯ğŸ‡µ",
  "412": "ğŸ‡¨ğŸ‡³", "413": "ğŸ‡¨ğŸ‡³", "414": "ğŸ‡¨ğŸ‡³", "416": "ğŸ‡¹ğŸ‡¼", "417": "ğŸ‡°ğŸ‡µ",
  "419": "ğŸ‡®ğŸ‡³", "422": "ğŸ‡®ğŸ‡±", "423": "ğŸ‡®ğŸ‡·", "424": "ğŸ‡°ğŸ‡¿", "425": "ğŸ‡·ğŸ‡º",
  "428": "ğŸ‡¸ğŸ‡¦", "431": "ğŸ‡¸ğŸ‡¬", "432": "ğŸ‡¹ğŸ‡­", "434": "ğŸ‡¹ğŸ‡·", "436": "ğŸ‡ºğŸ‡¿",
  "437": "ğŸ‡»ğŸ‡³", "440": "ğŸ‡°ğŸ‡·", "441": "ğŸ‡¯ğŸ‡µ", "443": "ğŸ‡²ğŸ‡¾", "445": "ğŸ‡µğŸ‡­",
  "447": "ğŸ‡°ğŸ‡µ", "450": "ğŸ‡§ğŸ‡©", "451": "ğŸ‡°ğŸ‡­", "453": "ğŸ‡±ğŸ‡¦", "455": "ğŸ‡²ğŸ‡²",
  "457": "ğŸ‡µğŸ‡°", "459": "ğŸ‡±ğŸ‡°", "501": "ğŸ‡¦ğŸ‡º", "503": "ğŸ‡¦ğŸ‡º", "506": "ğŸ‡³ğŸ‡¿",
  "508": "ğŸ‡µğŸ‡¬", "510": "ğŸ‡«ğŸ‡¯", "511": "ğŸ‡²ğŸ‡­", "512": "ğŸ‡³ğŸ‡·", "513": "ğŸ‡³ğŸ‡¿",
  "514": "ğŸ‡¹ğŸ‡´", "515": "ğŸ‡¹ğŸ‡»", "516": "ğŸ‡¼ğŸ‡¸", "518": "ğŸ‡»ğŸ‡º", "601": "ğŸ‡¿ğŸ‡¦",
  "603": "ğŸ‡¦ğŸ‡´", "605": "ğŸ‡§ğŸ‡®", "607": "ğŸ‡¨ğŸ‡²", "608": "ğŸ‡¨ğŸ‡»", "609": "ğŸ‡¨ğŸ‡«",
  "610": "ğŸ‡¨ğŸ‡¬", "611": "ğŸ‡¨ğŸ‡©", "612": "ğŸ‡§ğŸ‡¯", "613": "ğŸ‡¬ğŸ‡¦", "615": "ğŸ‡¬ğŸ‡²",
  "616": "ğŸ‡¬ğŸ‡³", "617": "ğŸ‡¨ğŸ‡®", "618": "ğŸ‡°ğŸ‡ª", "619": "ğŸ‡±ğŸ‡·", "620": "ğŸ‡²ğŸ‡¬",
  "621": "ğŸ‡²ğŸ‡¼", "622": "ğŸ‡²ğŸ‡±", "624": "ğŸ‡²ğŸ‡·", "625": "ğŸ‡²ğŸ‡¿", "626": "ğŸ‡³ğŸ‡¦",
  "627": "ğŸ‡³ğŸ‡ª", "628": "ğŸ‡³ğŸ‡¬", "630": "ğŸ‡¸ğŸ‡¹", "631": "ğŸ‡¸ğŸ‡³", "632": "ğŸ‡¸ğŸ‡¨",
  "633": "ğŸ‡¸ğŸ‡±", "634": "ğŸ‡¸ğŸ‡´", "635": "ğŸ‡¿ğŸ‡¦", "636": "ğŸ‡¸ğŸ‡©", "637": "ğŸ‡¸ğŸ‡¿",
  "638": "ğŸ‡¹ğŸ‡¿", "639": "ğŸ‡¹ğŸ‡¬", "640": "ğŸ‡¹ğŸ‡³", "641": "ğŸ‡ºğŸ‡¬", "642": "ğŸ‡¿ğŸ‡²",
  "643": "ğŸ‡¿ğŸ‡¼", "645": "ğŸ‡ªğŸ‡·", "647": "ğŸ‡ªğŸ‡¹", "649": "ğŸ‡²ğŸ‡º", "650": "ğŸ‡¸ğŸ‡­"
}
;
  return landcodes[mmsi?.toString().substring(0, 3)] || "ğŸ³ï¸";
}

document.getElementById("etdForm").addEventListener("submit", async function (e) {
    
    // Vul de hidden input altijd met de handmatige waarde
    document.getElementById("hiddenHandmatigScheepsnaam").value = manualField.value || "";

  e.preventDefault();

  const nu = Date.now();
  const tijdSindsLaatste = nu - laatstVerzonden;

  const etdField = document.getElementById("etd");
  const redenField = document.getElementById("reden");
  const etd = etdField.value.trim();
  const reden = redenField.value.trim();

  // Reset borders
  etdField.style.border = "";
  redenField.style.border = "";

  // Controleer of het formulier geldig is (ETD of reden vereist)
  if (!etd && !reden) {
    etdField.style.border = "2px solid red";
    redenField.style.border = "2px solid red";
    return;
  }

  // Controleer throttle alleen bij geldig formulier
  if (tijdSindsLaatste < 60000) {
    alert("Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.");
    return;
  }

  const data = {
    scheepsnaam: document.getElementById("huidigSchipSelect").value,
    scheepsnaamHandmatig: document.getElementById("handmatigSchip").value,
    etd,
    reden,
    toelichting: document.getElementById("toelichting").value.trim(),
    type: document.getElementById('berichtTypeValue').value,
    timestamp: new Date().toISOString()
  };

  const csv = `Scheepsnaam, scheepsnaamHandmatig,ETD,RedenGeenETD,Toelichting,Timestamp\n${data.scheepsnaam},${data.scheepsnaamHandmatig},${data.etd},${data.reden},${data.toelichting},${data.type},${data.timestamp}`;

  const onderwerp = data.etd ?
    `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}` :
    `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

  const res = await fetch("/api/verstuur", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv, onderwerp })
  });

  if (res.ok) {
    laatstVerzonden = Date.now();
    document.getElementById("bevestiging").style.display = "block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
  setTimeout(() => {
    location.reload();
  }, 30000); // herlaad na 30 seconden

    vuurConfettiSerie();
  } else {
    alert("âŒ Fout bij verzenden");
  }
});

function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();
    if (timeLeft <= 0) return clearInterval(interval);

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}

window.onload = laadSchepen;

setTimeout(() => {
  const select = document.getElementById("huidigSchipSelect");
  if (select && select.options.length === 1 && select.options[0].textContent.includes("Laden")) {
    select.disabled = true;
    document.getElementById("gpsButton").disabled = true;
    document.getElementById("gpsFoutmelding").innerText = "âš ï¸ Functie niet beschikbaar, vul handmatig in.";
    const handmatig = document.getElementById("handmatigSchip");
    handmatig.disabled = false;
    handmatig.focus();
  }
}, 5000);</script><script>
// Vul datalist met scheepsnamen uit fetch
async function vulAutoAan() {
  try {
    const res = await fetch("/api/schepen");
    const schepen = await res.json();
    const lijst = document.getElementById("schiplijst");
    lijst.innerHTML = "";
    schepen.forEach(s => {
      if (s.naam) {
        const opt = document.createElement("option");
        opt.value = s.naam;
        lijst.appendChild(opt);
      }
    });
  } catch (err) {
    console.error("Auto-aanvul fout:", err);
  }
}

document.getElementById("handmatigSchip").addEventListener("input", function () {
  document.getElementById("huidigSchipSelect").value = ""; // reset dropdown keuze
});

window.onload = function () {
  laadSchepen();
  vulAutoAan();
};
</script><script>
function forceerGPSLaad() {
  navigator.geolocation.getCurrentPosition(
    async (geo) => {
      const lat = geo.coords.latitude;
      const lon = geo.coords.longitude;

      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();

        const dichtbij = schepen
          .map(s => {
            const laatst = s.track?.[s.track.length - 1];
            if (!s.naam || !s.mmsi || !laatst) return null;
            const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
            return { naam: s.naam, mmsi: s.mmsi, afstand };
          })
          .filter(Boolean)
          .sort((a, b) => a.afstand - b.afstand)
          .slice(0, 15);

        const select = document.getElementById("huidigSchipSelect");
        select.innerHTML = "";

        dichtbij.forEach((s, i) => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
          if (i === 0) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("GPS refresh fout:", err);
      }
    },
    (err) => {
      alert("Kon GPS-locatie niet ophalen: " + err.message);
    }
  );
}
</script><script>
// IDs van velden
const selectField = document.getElementById("huidigSchipSelect");
const manualField = document.getElementById("handmatigSchip");
const gpsButton = document.getElementById("gpsButton");

// Helper om select en gps (de)activeren en transparantie zetten
function setSelectAndGPS(disabled) {
    selectField.disabled = disabled;
    gpsButton.disabled = disabled;
    selectField.style.opacity = disabled ? "0.5" : "1";
    gpsButton.style.opacity = disabled ? "0.5" : "1";
}

// Direct na laden: handmatige veld altijd actief
window.addEventListener("DOMContentLoaded", function() {
    if (manualField) manualField.disabled = false;
    setSelectAndGPS(false);

    // 5-seconden check of laden klaar is
    setTimeout(function() {
        // Controleer of eerste optie nog steeds 'Laden...' is
        if (selectField && selectField.options.length && selectField.options[0].textContent.includes('Laden')) {
            setSelectAndGPS(true);
        }
    }, 5000);
});

// Wanneer je in het handmatige veld typt
manualField && manualField.addEventListener("input", function() {
    if (manualField.value.trim() !== "") {
        setSelectAndGPS(true);
        selectField.value = "";
    } else {
        // Alleen weer activeren als er wÃ©l schepen geladen zijn (dus niet als nog 'Laden...')
        if (selectField && (!selectField.options.length || !selectField.options[0].textContent.includes('Laden'))) {
            setSelectAndGPS(false);
        }
    }
});

// Zorg dat handmatige veld zijn datalist-link houdt
if (manualField) manualField.disabled = false;

</script>


<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('âœ… Service Worker geregistreerd:', reg.scope))
        .catch(err => console.warn('âŒ Service Worker fout:', err));
    });
  }
</script>


<script>
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      location.reload();
    }
  });
</script>


<div id="infoModal"
     style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.38);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:24px 18px 16px 18px;border-radius:18px;max-width:400px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;">
    <button id="closeModal" type="button"
            style="position:absolute;top:10px;right: -150px;font-size:22px;color:#003b5c;background:none;border:none;cursor:pointer;font-weight:bold;line-height:1;">&times;</button>
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Informatie</h2>
    <p style="color:#28323c;">
      Deze app is onderdeel van het MMP14-onderzoek en onderzoekt
    de waarde van het opvragen van de ETD bij de kapitein van een binnenkomend of verhalend schip.<br><br>
      Scheepsnaam wordt doormiddel van GPS locatie automatisch gezocht.
      Mocht de voorgestelde scheepsnaam niet kloppen dan kan hij handmatig ingevuld worden. <br><br>
      
      Check: <b>Scheepsnaam, ETD of Reden geen ETD, Type reis: Binnenkomend of Verhalend.</b><br><br>
      Bedankt voor uw bijdrage!
    </p>
  </div>
</div>


<script>
  // Info popup
  document.getElementById('infoButton').onclick = function(e) {
    e.preventDefault();
    document.getElementById('infoModal').style.display = 'flex';
  };
  document.getElementById('closeModal').onclick = function() {
    document.getElementById('infoModal').style.display = 'none';
  };
  // Toggle switch
  const typeSwitch = document.getElementById('typeSwitch');
  const switchDot = document.getElementById('switchDot');
  const berichtTypeValue = document.getElementById('berichtTypeValue');
  const verhalendLabel = document.getElementById('verhalendLabel');
  const binnenkomendLabel = document.getElementById('binnenkomendLabel');
  function updateToggleUI() {
    if(typeSwitch.checked) {
      switchDot.style.left = '22px';
      berichtTypeValue.value = 'Verhalend';
      verhalendLabel.style.fontWeight = 'bold';
      verhalendLabel.style.color = '#85d678';
      binnenkomendLabel.style.color = '#f8f9fa';
      binnenkomendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '.5';
      verhalendLabel.style.opacity = '1';
    
    } else {
      switchDot.style.left = '2px';
      berichtTypeValue.value = 'Binnenkomend';
      binnenkomendLabel.style.fontWeight = 'bold';
      binnenkomendLabel.style.color = '#85d678';
      verhalendLabel.style.color = '#f8f9fa';
      verhalendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '1';
      verhalendLabel.style.opacity = '.5';
    }
  }
  typeSwitch.onchange = updateToggleUI;
  updateToggleUI();
</script>

</body>
</html>
