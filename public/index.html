
<!DOCTYPE html>

<html lang="nl">
<head><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>ETD Formulier</title>
<style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
    button {
      background: #003b5c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
    }
    #bevestiging {
      display: none;
      padding: 1rem;
      background: #dff0d8;
      color: #3c763d;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
  

    form {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      border-radius: 1rem;
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    
    body {
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    @keyframes achtergrondFade {
      0%   { filter: brightness(1); }
      100% { filter: brightness(0.95); }
    }

    form {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
      padding: 1rem;
      border-radius: 1rem;
      backdrop-filter: blur(4px);
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    

    .form-container {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.8);
      border-radius: 0.1rem;
      padding: 0.1rem;
      backdrop-filter: blur(6px);
      max-width: 600px;
      margin: auto;
    }

    .form-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-header img {
      max-height: 100px;
      margin-bottom: 0.2rem;
    }

    .form-header h2 {
      color: white;
      margin: 0;
      font-size: 1.5rem;
    }
    

    .form-header h2 {
      color: #003b5c;
    }

    label {
      color: #003b5c;
    }

    #bevestiging {
      background-color: rgba(200, 255, 200, 0.9);
      color: #003b5c;
    }

    button {
      background-color: #85d678;
      color: white;
    }
    

    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    button {
      width: 100%;
      margin-top: 1rem;
    }
    
    
    body, label, h2 {
      color: #f8f9fa;
    }

    input, textarea, select {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
      border: 1px solid #ccc;
    }

    select option {
      color: #000;
      background-color: #fff;
    }
    
    .form-container {
      background-color: rgba(255, 255, 255, 0.7); /* 70% opaque wit */
      box-shadow: none; /* verwijder donkere rand */
      backdrop-filter: blur(10px);
    }
    
    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    input, select, textarea {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }
    
    body {
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }
    
    #gpsButton {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background: linear-gradient(to bottom right, #007bff, #66b3ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    #gpsButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    select:disabled, #gpsButton:disabled {
      opacity: 0.5;
    }
    
    .foutmelding {
      color: red;
      font-weight: bold;
      text-align: center;
      margin-top: 0.5rem;
    }

    #handmatigSchip {
      opacity: 0.5;
    }

    #handmatigSchip:enabled {
      opacity: 1;
    }
    

.toggle-switch-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 1.3rem;
  margin-top: 0.2rem;
}
#switchLabel {
  cursor: pointer;
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  background: #e5e7eb;
  border-radius: 20px;
  box-shadow: 0 2px 8px #0002;
  margin: 0 3px;
}
#switchDot {
  position: absolute;
  left: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: all 0.22s cubic-bezier(.8,.5,.2,1.4);
  box-shadow: 0 1px 4px #003b5c22;
}
input[type="checkbox"]#typeSwitch {
  display: none;
}

.infobutton-page {
  position: fixed;
  top: 40px;
  right: 40px;
  width: 50px;
  background: none;
  border: none;
  padding: 0;
  margin: 0;
  z-index: 2022;
  cursor: pointer;
}

.info-circle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 42px;
  height: 42px;
  background: #ededf0;
  color: #003b5c;
  font-size: 1.7rem;
  font-family: Arial, sans-serif;
  border-radius: 50%;
  font-weight: bold;
  box-shadow: 0 2px 16px 0 #003b5c44;
  user-select: none;
  border: 2px solid #bfc3cc;
  transition: background 0.13s, color 0.13s;
}
    .infobutton-page:active .info-circle,
.infobutton-page:focus .info-circle {
  background: #2563eb;
  color: #fff;
  outline: none;
}

</style>

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#003b5c" />

</head>

<body>
  <button id="infoButton" type="button" title="Meer informatie" class="infobutton-page">
    <span class="info-circle">i</span>
  </button>
  <div id="bevestiging">‚úîÔ∏è Inzending succesvol verzonden</div>
  <div class="form-container">
    <div class="form-header">
      <img alt="logo" src="https://hansklok123.github.io/aisset/logo.png"/>
      <h2>ETD Formulier</h2>
    </div>
    <form id="etdForm">
      <label>Scheepsnaam:
        <select id="huidigSchipSelect" name="scheepsnaam"><option value="">Laden...</option></select>
      </label>
      <button id="gpsButton" onclick="forceerGPSLaad()" type="button">üìç Haal locatie op</button>
      <div class="foutmelding" id="gpsFoutmelding"></div>
      <label>Of typ handmatig de scheepsnaam:</label>
      <input disabled="true" id="handmatigSchip" list="schiplijst" name="handmatig_scheepsnaam" placeholder="Begin met typen..." type="text"/>
      <input type="hidden" id="hiddenHandmatigScheepsnaam" name="ScheepsnaamHandmatig">
      <datalist id="schiplijst"></datalist>
      <label>ETD:
        <input id="etd" name="etd" type="datetime-local"/>
      </label>
      <label>Reden indien geen ETD:
        <select id="reden" name="reden">
          <option value="">-- Kies reden --</option>
          <option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
          <option value="Taal barri√®re">Taal barri√®re</option>
          <option value="Overig">Overig</option>
        </select>
      </label>
      <label>Toelichting (optioneel):
        <textarea id="toelichting" name="toelichting" rows="4"></textarea>
      <label for="typeSwitch">Type reis gevraagd:</label>
      <div class="toggle-switch-row">
        <span id="binnenkomendLabel">Binnenkomend</span>
        <input type="checkbox" id="typeSwitch" name="berichtType" style="display:none;">
        <label for="typeSwitch" id="switchLabel">
          <span id="switchDot"></span>
        </label>
        <span id="verhalendLabel">Verhalend</span>
        <input type="hidden" name="berichtTypeValue" id="berichtTypeValue" value="Binnenkomend">
      </div>
      <button type="submit">Verzenden</button>
    </form>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    function vuurConfettiSerie() {
      var duration = 2 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };
      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }
      var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, {
          particleCount,
          origin: {
            x: randomInRange(0.1, 0.9),
            y: Math.random() - 0.2
          }
        }));
      }, 200);
    }
  </script>
  <script>
    let laatstVerzonden = 0;
    let laatsteLat = "";
    let laatsteLon = "";

    navigator.geolocation.getCurrentPosition(
      (geo) => {
        laatsteLat = geo.coords.latitude;
        laatsteLon = geo.coords.longitude;
      },
      () => {}
    );

    document.getElementById("reden").addEventListener("change", function () {
      const toelichting = document.getElementById("toelichting");
      if (this.value) {
        toelichting.removeAttribute("disabled");
      } else {
        toelichting.setAttribute("disabled", "true");
        toelichting.value = "";
      }
    });

    async function laadSchepen() {
      try {
        const geo = await new Promise((resolve, reject) =>
          navigator.geolocation.getCurrentPosition(resolve, reject)
        );
        const lat = geo.coords.latitude;
        const lon = geo.coords.longitude;
        laatsteLat = lat;
        laatsteLon = lon;
        const res = await fetch("/api/schepen");
        const schepen = await res.json();
        const dichtbij = schepen
          .map(s => {
            const laatst = s.track?.[s.track.length - 1];
            if (!s.naam || !s.mmsi || !laatst) return null;
            const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
            return { naam: s.naam, mmsi: s.mmsi, afstand };
          })
          .filter(Boolean)
          .sort((a, b) => a.afstand - b.afstand)
          .slice(0, 15);
        const select = document.getElementById("huidigSchipSelect");
        select.innerHTML = "";
        dichtbij.forEach((s, i) => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
          if (i === 0) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Fout bij laden schepen:", err);
      }
    }

    function afstandKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function landVlag(mmsi) {
      return "üè≥Ô∏è";
    }

    // ENKEL DIT SUBMIT SCRIPT IS GEWIJZIGD:
    document.getElementById("etdForm").addEventListener("submit", async function (e) {
      document.getElementById("hiddenHandmatigScheepsnaam").value = handmatigSchip.value || "";
      e.preventDefault();
      const nu = Date.now();
      const tijdSindsLaatste = nu - laatstVerzonden;
      const etdField = document.getElementById("etd");
      const redenField = document.getElementById("reden");
      const etd = etdField.value.trim();
      const reden = redenField.value.trim();
      // Reset borders
      etdField.style.border = "";
      redenField.style.border = "";
      if (!etd && !reden) {
        etdField.style.border = "2px solid red";
        redenField.style.border = "2px solid red";
        return;
      }
      if (tijdSindsLaatste < 60000) {
        alert("Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.");
        return;
      }
      const data = {
        scheepsnaam: document.getElementById("huidigSchipSelect").value,
        scheepsnaamHandmatig: document.getElementById("handmatigSchip").value,
        etd,
        reden,
        toelichting: document.getElementById("toelichting").value.trim(),
        Status: document.getElementById('berichtTypeValue').value,
        timestamp: new Date().toISOString(),
        latitude: laatsteLat,
        longitude: laatsteLon
      };
      const res = await fetch("/api/verstuur", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      if (res.ok) {
        laatstVerzonden = Date.now();
        document.getElementById("bevestiging").style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
          location.reload();
        }, 30000);
        vuurConfettiSerie();
      } else {
        alert("‚ùå Fout bij verzenden");
      }
    });

    function forceerGPSLaad() {
      navigator.geolocation.getCurrentPosition(
        async (geo) => {
          const lat = geo.coords.latitude;
          const lon = geo.coords.longitude;
          laatsteLat = lat; laatsteLon = lon;
          try {
            const res = await fetch("/api/schepen");
            const schepen = await res.json();
            const dichtbij = schepen
              .map(s => {
                const laatst = s.track?.[s.track.length - 1];
                if (!s.naam || !s.mmsi || !laatst) return null;
                const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
                return { naam: s.naam, mmsi: s.mmsi, afstand };
              })
              .filter(Boolean)
              .sort((a, b) => a.afstand - b.afstand)
              .slice(0, 15);
            const select = document.getElementById("huidigSchipSelect");
            select.innerHTML = "";
            dichtbij.forEach((s, i) => {
              const opt = document.createElement("option");
              opt.value = s.naam;
              opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
              if (i === 0) opt.selected = true;
              select.appendChild(opt);
            });
          } catch (err) {
            console.error("GPS refresh fout:", err);
          }
        },
        (err) => {
          alert("Kon GPS-locatie niet ophalen: " + err.message);
        }
      );
    }
    async function vulAutoAan() {
      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();
        const lijst = document.getElementById("schiplijst");
        lijst.innerHTML = "";
        schepen.forEach(s => {
          if (s.naam) {
            const opt = document.createElement("option");
            opt.value = s.naam;
            lijst.appendChild(opt);
          }
        });
      } catch (err) {
        console.error("Auto-aanvul fout:", err);
      }
    }
    document.getElementById("handmatigSchip").addEventListener("input", function () {
      document.getElementById("huidigSchipSelect").value = "";
    });
    window.onload = function () {
      laadSchepen();
      vulAutoAan();
    };
  </script>
</body>
</html>

