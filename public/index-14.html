
<!DOCTYPE html>

<html lang="nl">
<head><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>ETD Formulier</title>
<style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 2rem; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
    button {
      background: #003b5c;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1.5rem;
    }
    #bevestiging {
      display: none;
      padding: 1rem;
      background: #dff0d8;
      color: #3c763d;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
  
    body {
      background: url('https://storage.rotterdammaritimecapital.com/storage/2018/08/01152337/RMCOE_Port-and-Logistics.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }

    form {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 1rem;
      border-radius: 1rem;
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    
    body {
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    @keyframes achtergrondFade {
      0%   { filter: brightness(1); }
      100% { filter: brightness(0.95); }
    }

    form {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
      padding: 1rem;
      border-radius: 1rem;
      backdrop-filter: blur(4px);
    }

    input, select, textarea, button {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }

    label {
      font-weight: bold;
      color: #fff;
    }

    #bevestiging {
      background-color: rgba(144, 238, 144, 0.9);
      color: #003b5c;
    }
    

    .form-container {
      background-color: rgba(0, 0, 0, 0.65);
      box-shadow: 0 0 18px rgba(0, 0, 0, 0.8);
      border-radius: 1rem;
      padding: 1.5rem;
      backdrop-filter: blur(6px);
      max-width: 600px;
      margin: auto;
    }

    .form-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .form-header img {
      max-height: 100px;
      margin-bottom: 0.2rem;
    }

    .form-header h2 {
      color: white;
      margin: 0;
      font-size: 1.5rem;
    }
    

    .form-header h2 {
      color: #003b5c;
    }

    label {
      color: #003b5c;
    }

    #bevestiging {
      background-color: rgba(200, 255, 200, 0.9);
      color: #003b5c;
    }

    button {
      background-color: #85d678;
      color: white;
    }
    

    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    button {
      width: 100%;
      margin-top: 1rem;
    }
    
    
    body, label, h2 {
      color: #f8f9fa;
    }

    input, textarea, select {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
      border: 1px solid #ccc;
    }

    select option {
      color: #000;
      background-color: #fff;
    }
    
    .form-container {
      background-color: rgba(255, 255, 255, 0.7); /* 70% opaque wit */
      box-shadow: none; /* verwijder donkere rand */
      backdrop-filter: blur(10px);
    }
    
    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    input, select, textarea {
      background-color: rgba(255, 255, 255, 0.95);
      color: #000;
    }
    
    body {
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
      animation: achtergrondFade 20s ease-in-out infinite alternate;
    }

    .form-container {
      background: none !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }
    
    #gpsButton {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      background: linear-gradient(to bottom right, #007bff, #66b3ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    #gpsButton:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    select:disabled, #gpsButton:disabled {
      opacity: 0.5;
    }
    
    .foutmelding {
      color: red;
      font-weight: bold;
      text-align: center;
      margin-top: 0.5rem;
    }

    #handmatigSchip {
      opacity: 0.5;
    }

    #handmatigSchip:enabled {
      opacity: 1;
    }
    </style>
</head>
<body>
<div id="bevestiging">‚úîÔ∏è Inzending succesvol verzonden</div>
<div class="form-container">
<div class="form-header">
<img alt="logo" src="https://hansklok123.github.io/aisset/logo.png"/>
</div>
<form id="etdForm">
<h2>ETD Invoeren</h2>
<label>Scheepsnaam:<select id="huidigSchipSelect" name="scheepsnaam"><option value="">Laden...</option></select></label><button id="gpsButton" onclick="forceerGPSLaad()" type="button">üìç Haal locatie op</button><div class="foutmelding" id="gpsFoutmelding"></div><label>Of typ handmatig de scheepsnaam:</label><input disabled="true" id="handmatigSchip" list="schiplijst" name="handmatig_scheepsnaam" placeholder="Begin met typen..." type="text"/><datalist id="schiplijst"></datalist><label>ETD:
      <input id="etd" name="etd" type="datetime-local"/>
</label>
<label>Reden indien geen ETD:
      <select id="reden" name="reden">
<option value="">-- Kies reden --</option>
<option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
<option value="Taal barri√®re">Taal barri√®re</option>
<option value="Overig">Overig</option>
</select>
</label>
<label>Toelichting (optioneel):
      <textarea disabled="true" id="toelichting" name="toelichting" rows="4"></textarea>
</label>
<button type="submit">Verzenden</button>
</form></div>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><script>
function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}
</script><script>
let laatstVerzonden = 0;

document.getElementById("etdForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const nu = Date.now();
  const tijdSindsLaatste = nu - laatstVerzonden;

  const etdField = document.getElementById("etd");
  const redenField = document.getElementById("reden");
  const handmatig = document.getElementById("handmatigSchip");
  const select = document.getElementById("huidigSchipSelect");

  const etd = etdField.value.trim();
  const reden = redenField.value.trim();
  const scheepsnaam = !select.disabled && select.value ? select.value.trim() : handmatig.value.trim();

  etdField.style.border = "";
  redenField.style.border = "";
  select.style.border = "";
  handmatig.style.border = "";

  if (!scheepsnaam) {
    select.style.border = "2px solid red";
    handmatig.style.border = "2px solid red";
    return;
  }

  if (!etd && !reden) {
    etdField.style.border = "2px solid red";
    redenField.style.border = "2px solid red";
    return;
  }

  if (tijdSindsLaatste < 5000) {
    alert("Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.");
    return;
  }

  const data = {
    scheepsnaam,
    etd,
    reden,
    toelichting: document.getElementById("toelichting").value.trim(),
    timestamp: new Date().toISOString()
  };

  const csv = `Scheepsnaam,ETD,RedenGeenETD,Toelichting,Timestamp\n${data.scheepsnaam},${data.etd},${data.reden},${data.toelichting},${data.timestamp}`;

  const onderwerp = data.etd ?
    `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}` :
    `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

  const res = await fetch("/api/verstuur", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv, onderwerp })
  });

  if (res.ok) {
    laatstVerzonden = Date.now();
    document.getElementById("bevestiging").style.display = "block";
    vuurConfettiSerie();
  } else {
    alert("‚ùå Fout bij verzenden");
  }
});
</script><script>
// Vul datalist met scheepsnamen uit fetch
async function vulAutoAan() {
  try {
    const res = await fetch("/api/schepen");
    const schepen = await res.json();
    const lijst = document.getElementById("schiplijst");
    lijst.innerHTML = "";
    schepen.forEach(s => {
      if (s.naam) {
        const opt = document.createElement("option");
        opt.value = s.naam;
        lijst.appendChild(opt);
      }
    });
  } catch (err) {
    console.error("Auto-aanvul fout:", err);
  }
}

document.getElementById("handmatigSchip").addEventListener("input", function () {
  document.getElementById("huidigSchipSelect").value = ""; // reset dropdown keuze
});

window.onload = function () {
  laadSchepen();
  vulAutoAan();
};
</script><script>
function forceerGPSLaad() {
  navigator.geolocation.getCurrentPosition(
    async (geo) => {
      const lat = geo.coords.latitude;
      const lon = geo.coords.longitude;

      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();

        const dichtbij = schepen
          .map(s => {
            const laatst = s.track?.[s.track.length - 1];
            if (!s.naam || !s.mmsi || !laatst) return null;
            const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
            return { naam: s.naam, mmsi: s.mmsi, afstand };
          })
          .filter(Boolean)
          .sort((a, b) => a.afstand - b.afstand)
          .slice(0, 15);

        const select = document.getElementById("huidigSchipSelect");
        select.innerHTML = "";

        dichtbij.forEach((s, i) => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
          if (i === 0) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("GPS refresh fout:", err);
      }
    },
    (err) => {
      alert("Kon GPS-locatie niet ophalen: " + err.message);
    }
  );
}
</script><script>
let gpsTimeout;

function forceerGPSLaad() {
  const knop = document.getElementById("gpsButton");
  knop.disabled = false;

  const select = document.getElementById("huidigSchipSelect");
  select.innerHTML = "<option>Laden...</option>";

  navigator.geolocation.getCurrentPosition(
    async (geo) => {
      const lat = geo.coords.latitude;
      const lon = geo.coords.longitude;

      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();

        const dichtbij = schepen
          .map(s => {
            const laatst = s.track?.[s.track.length - 1];
            if (!s.naam || !s.mmsi || !laatst) return null;
            const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
            return { naam: s.naam, mmsi: s.mmsi, afstand };
          })
          .filter(Boolean)
          .sort((a, b) => a.afstand - b.afstand)
          .slice(0, 15);

        clearTimeout(gpsTimeout);

        select.innerHTML = "";

        dichtbij.forEach((s, i) => {
          const opt = document.createElement("option");
          opt.value = s.naam;
          opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
          if (i === 0) opt.selected = true;
          select.appendChild(opt);
        });

        knop.disabled = false;
        select.disabled = false;
      } catch (err) {
        console.error("GPS refresh fout:", err);
      }
    },
    (err) => {
      alert("Kon GPS-locatie niet ophalen: " + err.message);
    }
  );

  gpsTimeout = setTimeout(() => {
    if (select.options.length === 1 && select.options[0].text === "Laden...") {
      select.disabled = true;
      knop.disabled = true;
      document.getElementById("gpsFoutmelding").innerText = "‚ö†Ô∏è Functie niet beschikbaar, vul handmatig in.";
      const handmatig = document.getElementById("handmatigSchip");
      handmatig.disabled = false;
      handmatig.focus();
    }
  }, 5000);
}

document.getElementById("etdForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const nu = Date.now();
  const tijdSindsLaatste = nu - laatstVerzonden;

  const etdField = document.getElementById("etd");
  const redenField = document.getElementById("reden");
  const etd = etdField.value.trim();
  const reden = redenField.value.trim();

  etdField.style.border = "";
  redenField.style.border = "";

  const schipSelect = document.getElementById("huidigSchipSelect");
  const handmatig = document.getElementById("handmatigSchip");
  const scheepsnaam = schipSelect.disabled || schipSelect.value === "" ? handmatig.value.trim() : schipSelect.value.trim();

  // Scheepsnaam verplicht
  if (!scheepsnaam) {
    schipSelect.style.border = "2px solid red";
    handmatig.style.border = "2px solid red";
    return;
  }

  if (!etd && !reden) {
    etdField.style.border = "2px solid red";
    redenField.style.border = "2px solid red";
    return;
  }

  if (tijdSindsLaatste < 60000) {
    alert("Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.");
    return;
  }

  const data = {
    scheepsnaam,
    etd,
    reden,
    toelichting: document.getElementById("toelichting").value.trim(),
    timestamp: new Date().toISOString()
  };

  const csv = `Scheepsnaam,ETD,RedenGeenETD,Toelichting,Timestamp\n${data.scheepsnaam},${data.etd},${data.reden},${data.toelichting},${data.timestamp}`;

  const onderwerp = data.etd ?
    `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}` :
    `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

  const res = await fetch("/api/verstuur", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv, onderwerp })
  });

  if (res.ok) {
    laatstVerzonden = Date.now();
    document.getElementById("bevestiging").style.display = "block";
    vuurConfettiSerie();
  } else {
    alert("‚ùå Fout bij verzenden");
  }
});
</script></body>
</html>
