
<!DOCTYPE html>

<html lang="nl">
<head><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<title>ETD Formulier</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
    font-family: sans-serif;
    overflow-x: hidden;
}

.bg {
  position: fixed;
  z-index: -1;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw;
  height: 100vh;
  background: url('https://keystoneacademic-res.cloudinary.com/image/upload/f_auto/q_auto/g_auto/w_724/dpr_2.0/element/11/119872_rotterdam-4152380_1920.jpg') no-repeat center center;
  background-size: cover;
  animation: achtergrondFade 20s ease-in-out infinite alternate;
  pointer-events: none;
}

  @keyframes achtergrondFade {
    0% { filter: brightness(1); }
    100% { filter: brightness(0.95); }
  }

  form, .form-container, .etd-row, .etd-col {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
  }

  form {
    background-color: rgba(0, 0, 0, 0.65);
    padding: 1rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

 .form-container {
    max-width: 600px;
    margin: auto;
    padding: 0.2rem;
}

  .form-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .form-header img {
    max-height: 100px;
    margin-bottom: 0.2rem;
  }

  .form-header h2 {
    font-size: 1.5rem;
    color: #003b5c;
  }

  label {
    display: block;
    margin-top: 1rem;
    font-weight: bold;
    color: #003b5c;
  }

  input, select, textarea, button {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 0.75rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 0.5rem;
    background-color: rgba(255, 255, 255, 0.95);
    color: #000;
  }

  input[type="datetime-local"] {
    min-height: 48px;
    display: block;
  }

  button {
    background: #003b5c;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 1.5rem;
  }

  #bevestiging {
    display: none;
    padding: 1rem;
    background-color: rgba(200, 255, 200, 0.9);
    color: #003b5c;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .etd-row {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
  }

  .foutmelding {
    color: red;
    font-weight: bold;
    text-align: center;
    margin-top: 0.5rem;
  }

  @keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
  }

  .shake {
    animation: shake 0.3s;
  }

  /* Info-knop */
  .infobutton-page {
    position: fixed;
    top: 40px;
    right: 40px;
    width: 50px;
    background: none;
    border: none;
    padding: 0;
    z-index: 2022;
    cursor: pointer;
  }

  .info-circle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 42px;
    height: 42px;
    background: #ededf0;
    color: #003b5c;
    font-size: 1.7rem;
    border-radius: 50%;
    font-weight: bold;
    border: 2px solid #bfc3cc;
    box-shadow: 0 2px 16px 0 #003b5c44;
  }

  .infobutton-page:active .info-circle,
  .infobutton-page:focus .info-circle {
    background: #2563eb;
    color: #fff;
  }


body, label, h2, .form-header h2 {
  color: #f8f9fa;
}

button {
  background-color: #85d678;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: bold;
  margin-top: 1.5rem;
}

#gpsButton {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  background: linear-gradient(to bottom right, #007bff, #66b3ff);
  color: white;
  font-weight: bold;
  cursor: pointer;
  margin-bottom: 1rem;
}

#gpsButton:disabled {
  background: #ccc;
  cursor: not-allowed;
  opacity: 0.5;
}

.toggle-switch-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 1.3rem;
  margin-top: 0.2rem;
}

#switchLabel {
  cursor: pointer;
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  background: #e5e7eb;
  border-radius: 20px;
  box-shadow: 0 2px 8px #0002;
  margin: 0 3px;
}

#switchDot {
  position: absolute;
  left: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  transition: all 0.22s cubic-bezier(.8,.5,.2,1.4);
  box-shadow: 0 1px 4px #003b5c22;
}

input[type="checkbox"]#typeSwitch {
  display: none;
}

#binnenkomendLabel, #verhalendLabel {
  color: #f8f9fa;
}

.etd-date-time-row {
  display: flex;
  gap: 8px;
}
.etd-date-time-row input {
  flex: 1 1 0;
}
</style>

<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#003b5c" />

</head>
<body>
<div class="bg"></div>
<div id="einddatumBanner" style="
  background: #2563eb;
  color: #fff;
  text-align: center;
  padding: 11px 18px;
  font-size: 1.08rem;
  border-radius: 0 0 18px 18px;
  box-shadow: 0 2px 18px #003b5c30;
  margin: 0 auto;
  max-width: 440px;
  transition: opacity 0.7s;
  opacity: 1;
  position: sticky;
  top: 0;
  z-index: 2000;
  left: 0;
  right: 0;
  display: block;
">
De dataverzameling loopt t/m 20 augustus 2025.<br>
</div>

<div id="policyModal" style="display:none;position:fixed;z-index:3000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:28px 18px 18px 18px;border-radius:18px;max-width:420px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;">
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Toestemmingsverklaring</h2>
    <div style="color:#28323c;font-size:1rem;max-height:180px;overflow:auto;margin-bottom:1rem;">
      <p>
        Door deze applicatie te gebruiken, geeft u toestemming voor het verwerken van uw gegevens voor onderzoeksdoeleinden.<br>
        Uw naam wordt uitsluitend gebruikt om uw toestemming vast te leggen en wordt niet gedeeld met derden.<br>
        Lees de <a href="#" id="showFullPrivacy" style="color:#2563eb;text-decoration:underline;">volledige informatie en privacyvoorwaarden</a> voor meer details.
      </p>
      <p>
        <b>Vul hieronder uw naam in om akkoord te gaan:</b>
      </p>
    </div>
    <input id="policyNameInput" type="text" placeholder="Uw naam" style="width:100%;padding:0.7rem;font-size:1rem;border-radius:8px;border:1px solid #ccc;margin-bottom:1rem;" />
    <div id="policyError" style="color:red;display:none;margin-bottom:0.5rem;">Vul uw naam in om akkoord te gaan.</div>
    <button id="policyAgreeBtn" style="background:#003b5c;color:#fff;padding:0.7rem 1.2rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer;width:100%;">Akkoord & Start</button>
  </div>
</div>

<!-- Uitgebreide privacy modal -->
<div id="fullPrivacyModal" style="display:none;position:fixed;z-index:4000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:18px 18px 18px 18px;padding-top:76px;border-radius:18px;max-width:540px;width:96vw;position:relative;box-shadow:0 4px 24px #003b5c33;max-height:90vh;overflow:auto;">
    <button id="closeFullPrivacy" type="button" style="position:absolute;top:10px;right:10px;font-size:28px;color:#003b5c;background:none;border:none;cursor:pointer;font-weight:bold;line-height:1;z-index:10;">&times;</button>
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Volledige informatie en privacyvoorwaarden</h2>
    <div style="color:#28323c;font-size:1rem;">
      <b>Toestemmingsverklaring voor gebruik van de ETD-webapplicatie</b><br><br>
      Deze webapplicatie is ontwikkeld voor het verzamelen van Estimated Time of Departure (ETD) van binnenkomende of verhalende schepen, zoals ingevoerd door loodsen. De ingevoerde gegevens worden gebruikt in het kader van een onderzoeksproject dat onderzoekt in hoeverre ETD-informatie bijdraagt aan een effici√´ntere inzetplanning van loodsen in het gebied Rotterdam-Rijnmond.<br><br>
      <b>Doel van het onderzoek</b><br>
      Het doel van dit project is om te onderzoeken in welke mate de ETD-invoer door loodsen helpt bij het verbeteren van de betrouwbaarheid en effici√´ntie van het planningsproces. Dit onderzoek wordt uitgevoerd in het kader van een afstudeerproject van de Maritieme Masteropleiding Pilotage, onder begeleiding van het Nederlands Loodswezen.<br><br>
      <b>Verwerking van gegevens</b><br>
      De ingevoerde gegevens worden niet gedeeld met derden.<br>
      Uw naam wordt uitsluitend opgeslagen om uw toestemming vast te leggen.<br>
      Alle andere gegevens worden anoniem verwerkt.<br>
      De data worden veilig opgeslagen volgens de richtlijnen van de Algemene Verordening Gegevensbescherming (AVG).<br>
      Geanonimiseerde gegevens kunnen worden gebruikt in rapportages en eventuele academische of professionele publicaties.<br><br>
      <b>Vrijwillige deelname</b><br>
      Het gebruik van deze applicatie is volledig vrijwillig. U kunt op elk moment stoppen met het invullen van gegevens. Als u eerder verzonden gegevens wilt laten verwijderen (zolang ze nog niet geanonimiseerd zijn), kunt u daar om verzoeken via onderstaande contactpersonen.<br><br>
      <b>Contact</b><br>
      Voor vragen over dit onderzoek kunt u contact opnemen met:
      Gijs Smit<br><br>
      <b>Toestemming</b><br>
      Door het formulier in te vullen en te verzenden, verklaart u dat:<br>
      - U deze informatie hebt gelezen en begrepen;<br>
      - U vrijwillig instemt met deelname aan dit project;<br>
      - U ten minste 18 jaar oud bent.
    </div>
  </div>
</div>

<script>
document.getElementById("showFullPrivacy").onclick = function(e) {
  e.preventDefault();
  document.getElementById("fullPrivacyModal").style.display = "flex";
};
document.getElementById("closeFullPrivacy").onclick = function() {
  document.getElementById("fullPrivacyModal").style.display = "none";
  // Alleen herladen als ?consent=1 in de URL staat
  if (window.location.search.includes("consent=1")) {
    window.location.href = window.location.pathname;
  }
};
</script>

<script>
window.addEventListener("scroll", function onScroll() {
  const banner = document.getElementById("einddatumBanner");
  if (!banner) return;
  if (window.scrollY > 30) {
    banner.style.opacity = "0";
    banner.style.pointerEvents = "none";
    setTimeout(() => banner.remove(), 700);
    window.removeEventListener("scroll", onScroll);
  }
});

</script>

    <button id="infoButton" type="button" title="Meer informatie" class="infobutton-page">
  <span class="info-circle">i</span>
</button>
    
<div id="bevestiging">‚úîÔ∏è Inzending succesvol, bedankt!<br><div id="wistjedat"></div></div>
<div class="form-container">

<div class="form-header">
<img alt="logo" src="https://hansklok123.github.io/aisset/logo.png"/>
</div>
<form id="etdForm">
<h2>ETD Invoeren</h2>
<label>Scheepsnaam:<select id="huidigSchipSelect" name="scheepsnaam"><option value="">Laden...</option></select></label><button id="gpsButton" onclick="forceerGPSLaad()" type="button">üìç Haal locatie op</button><div class="foutmelding" id="gpsFoutmelding"></div><label>Of typ handmatig de scheepsnaam:</label><input id="handmatigSchip" list="schiplijst" name="handmatig_scheepsnaam" placeholder="Begin met typen..." type="text"/>
<input type="hidden" id="hiddenHandmatigScheepsnaam" name="ScheepsnaamHandmatig"><datalist id="schiplijst"></datalist>

<div class="etd-row">
  <div class="etd-col etd-klein">
<div style="display: flex; gap: 8px; margin-bottom: 0.2rem; font-weight: bold;">
  <div style="flex:2;">ETD datum:</div>
  <div style="flex:1;">Tijd:</div>
</div>
<div style="display:flex; gap:8px;">
  <input id="etdDate" name="etdDate" type="date" style="flex:2; min-width:0;" />
  <input id="etdTime" name="etdTime" type="time" style="flex:1; min-width:0;" />
</div>
<div id="etdFoutmelding" style="display: none; color: red; font-weight: bold; margin-top: 0.2rem;">
  Vul eerst datum en geschatte tijd in
</div>
  </div>
  <div class="etd-col etd-groot">
    <label for="etdTijdvak">Vul in - indien tijd niet exact bekend:</label>
    <select id="etdTijdvak" name="etdTijdvak">
      <option value="">Tijdvak</option>
      <option value="00:00-06:00">Nacht 00:00 - 06:00</option>
      <option value="06:00-12:00">Ochtend 06:00 - 12:00</option>
      <option value="12:00-18:00">Middag 12:00 - 18:00</option>
      <option value="18:00-00:00">Avond 18:00 - 24:00</option>
    </select>
  </div>
</div>



<label>Reden indien geen ETD:
      <select id="reden" name="reden">
<option value="">-- Kies reden --</option>
<option value="Niet bekend bij de Kapitein">Niet bekend bij de Kapitein</option>
<option value="Taal barri√®re">Taal barri√®re</option>
<option value="Overig">Overig</option>
</select>
</label>
<label>Toelichting (optioneel):
      <textarea id="toelichting" name="toelichting" rows="4"></textarea>
<label for="typeSwitch">Type (huidige) reis:</label>
<div class="toggle-switch-row">
  <span id="binnenkomendLabel">Binnenkomend</span>
  <input type="checkbox" id="typeSwitch" name="berichtType" style="display:none;">
  <label for="typeSwitch"
    id="switchLabel">
    <span id="switchDot"></span>
  </label>
  <span id="verhalendLabel">Verhalend</span>
  <input type="hidden" name="berichtTypeValue" id="berichtTypeValue" value="Binnenkomend">
</div>

</label>
<button type="submit">Verzenden</button>
</form></div>

<button id="installBtn" style="display: none; position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #003b5c; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; z-index: 9999;">
  üì≤ App installeren
</button>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script><script>
function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();

    if (timeLeft <= 0) {
      return clearInterval(interval);
    }

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}
</script><script>
let laatstVerzonden = 0;

document.getElementById("reden").addEventListener("change", function () {
  const toelichting = document.getElementById("toelichting");
  if (this.value) {
    toelichting.removeAttribute("disabled");
  } else {
    toelichting.setAttribute("disabled", "true");
    toelichting.value = "";
  }
});

async function laadSchepen() {
  // Controleer of geolocatie beschikbaar is
  if (!("geolocation" in navigator)) {
    // Geen geolocatie: direct fallback
    setSelectAndGPS(true);
    const foutDiv = document.getElementById("gpsFoutmelding");
    foutDiv.innerText = "‚ö†Ô∏è Locatie niet beschikbaar, vul handmatig in.";
    foutDiv.style.display = "block";
    if (typeof vulAutoAan === "function") vulAutoAan();
    return;
  }
try {
  const geo = await new Promise((resolve, reject) =>
    navigator.geolocation.getCurrentPosition(resolve, reject)
  );

    const lat = geo.coords.latitude;
    const lon = geo.coords.longitude;

    const res = await fetch("/api/schepen");
    const schepen = await res.json();

    // Schepen verwerken en dropdown vullen:
    const select = document.getElementById("huidigSchipSelect");
    select.innerHTML = "";

    const dichtbij = schepen
      .map(s => {
        const laatst = s.track?.[s.track.length - 1];
        if (!s.naam || !s.mmsi || !laatst) return null;
        const afstand = afstandKm(lat, lon, laatst.lat, laatst.lon);
        return { naam: s.naam, mmsi: s.mmsi, afstand };
      })
      .filter(Boolean)
      .sort((a, b) => a.afstand - b.afstand)
      .slice(0, 15);

    dichtbij.forEach((s, i) => {
      const opt = document.createElement("option");
      opt.value = s.naam;
      opt.textContent = `${s.naam} ${landVlag(s.mmsi)} (${Math.round(s.afstand * 1000)}m)`;
      if (i === 0) opt.selected = true;
      select.appendChild(opt);
    });

    document.getElementById("handmatigSchip").disabled = false;
    setSelectAndGPS(false);

  } catch (err) {
    setSelectAndGPS(true);
    const foutDiv = document.getElementById("gpsFoutmelding");
    foutDiv.innerText = "‚ö†Ô∏è Locatie niet toegestaan, vul handmatig in.";
    foutDiv.style.display = "block";
    const handmatig = document.getElementById("handmatigSchip");
    handmatig.disabled = false;
    if (typeof vulAutoAan === "function") vulAutoAan();
  }
}

function afstandKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function landVlag(mmsi) {
  const landcodes = {
  "201": "üá¶üá±", "202": "üá¶üá©", "203": "üá¶üáπ", "204": "üáµüáπ", "205": "üáßüá™",
  "206": "üáßüáæ", "207": "üáßüá¨", "208": "üáªüá¶", "209": "üá®üáæ", "210": "üá®üáø",
  "211": "üá©üá™", "212": "üá™üá™", "213": "üá≤üáπ", "214": "üá¨üá∑", "215": "üá≠üá∑",
  "216": "üáÆüáπ", "218": "üáÆüá™", "219": "üáÆüá∏", "220": "üáÆüáπ", "224": "üá±üáª",
  "225": "üá±üáÆ", "226": "üá±üáπ", "227": "üá±üá∫", "228": "üá≤üá®", "229": "üá≤üáπ",
  "230": "üá≥üá¥", "231": "üáµüá±", "232": "üá¨üáß", "233": "üá¨üáß", "234": "üá¨üáß",
  "235": "üá¨üáß", "236": "üá¨üáÆ", "237": "üá∏üá∞", "238": "üá∏üáÆ", "239": "üá™üá∏",
  "240": "üá∏üá™", "241": "üá®üá≠", "242": "üá®üáø", "243": "üá≠üá∫", "244": "üá≥üá±",
  "245": "üá≥üá±", "246": "üá≥üá±", "247": "üá∏üá≤", "248": "üáªüá¶", "249": "üá≤üáπ",
  "250": "üá¨üá≥", "251": "üá≤üá∞", "252": "üá≤üá®", "253": "üá∏üá∞", "254": "üá∏üáÆ",
  "255": "üáµüáπ", "301": "üá©üá™", "302": "üá±üá∫", "303": "üá∫üá∏", "304": "üáßüá≤",
  "305": "üá®üá¶", "306": "üá∏üáΩ", "307": "üá®üáº", "308": "üáßüá∏", "309": "üá´üá¥",
  "310": "üá¶üá¨", "311": "üáßüáß", "312": "üáßüáø", "314": "üá©üá≤", "316": "üá®üá¶",
  "319": "üáØüá≤", "321": "üáªüá®", "323": "üáªüá™", "325": "üá∏üá∑", "327": "üá≤üá∏",
  "329": "üáπüáπ", "330": "üá¨üá©", "331": "üá∞üá≥", "332": "üá±üá®", "334": "üá≤üáΩ",
  "338": "üá∫üá∏", "339": "üá∫üá∏", "341": "üáµüá¶", "343": "üáßüá∑", "345": "üá∞üáæ",
  "348": "üáªüáÆ", "350": "üá¨üáπ", "351": "üá∏üáª", "352": "üá≠üá≥", "353": "üá≥üáÆ",
  "354": "üá®üá∑", "355": "üáµüá¶", "356": "üáµüá™", "357": "üá¶üá∑", "358": "üá®üá±",
  "359": "üá®üá¥", "361": "üáªüá™", "362": "üá∫üáæ", "364": "üáµüáæ", "366": "üá∫üá∏",
  "371": "üáµüá¶", "372": "üá™üá®", "373": "üáßüá¥", "375": "üáªüá™", "376": "üá¨üáπ",
  "400": "üá¶üá∫", "401": "üáÆüá©", "403": "üáÆüá≥", "405": "üá∞üá∑", "408": "üáØüáµ",
  "412": "üá®üá≥", "413": "üá®üá≥", "414": "üá®üá≥", "416": "üáπüáº", "417": "üá∞üáµ",
  "419": "üáÆüá≥", "422": "üáÆüá±", "423": "üáÆüá∑", "424": "üá∞üáø", "425": "üá∑üá∫",
  "428": "üá∏üá¶", "431": "üá∏üá¨", "432": "üáπüá≠", "434": "üáπüá∑", "436": "üá∫üáø",
  "437": "üáªüá≥", "440": "üá∞üá∑", "441": "üáØüáµ", "443": "üá≤üáæ", "445": "üáµüá≠",
  "447": "üá∞üáµ", "450": "üáßüá©", "451": "üá∞üá≠", "453": "üá±üá¶", "455": "üá≤üá≤",
  "457": "üáµüá∞", "459": "üá±üá∞", "501": "üá¶üá∫", "503": "üá¶üá∫", "506": "üá≥üáø",
  "508": "üáµüá¨", "510": "üá´üáØ", "511": "üá≤üá≠", "512": "üá≥üá∑", "513": "üá≥üáø",
  "514": "üáπüá¥", "515": "üáπüáª", "516": "üáºüá∏", "518": "üáªüá∫", "601": "üáøüá¶",
  "603": "üá¶üá¥", "605": "üáßüáÆ", "607": "üá®üá≤", "608": "üá®üáª", "609": "üá®üá´",
  "610": "üá®üá¨", "611": "üá®üá©", "612": "üáßüáØ", "613": "üá¨üá¶", "615": "üá¨üá≤",
  "616": "üá¨üá≥", "617": "üá®üáÆ", "618": "üá∞üá™", "619": "üá±üá∑", "620": "üá≤üá¨",
  "621": "üá≤üáº", "622": "üá≤üá±", "624": "üá≤üá∑", "625": "üá≤üáø", "626": "üá≥üá¶",
  "627": "üá≥üá™", "628": "üá≥üá¨", "630": "üá∏üáπ", "631": "üá∏üá≥", "632": "üá∏üá®",
  "633": "üá∏üá±", "634": "üá∏üá¥", "635": "üáøüá¶", "636": "üá∏üá©", "637": "üá∏üáø",
  "638": "üáπüáø", "639": "üáπüá¨", "640": "üáπüá≥", "641": "üá∫üá¨", "642": "üáøüá≤",
  "643": "üáøüáº", "645": "üá™üá∑", "647": "üá™üáπ", "649": "üá≤üá∫", "650": "üá∏üá≠"
}
;
  return landcodes[mmsi?.toString().substring(0, 3)] || "üè≥Ô∏è";
}

document.getElementById("etdForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  // Pak de juiste elementen
  const etdDateField = document.getElementById("etdDate");
  const etdTimeField = document.getElementById("etdTime");
  const tijdvakField = document.getElementById("etdTijdvak");
  const redenField = document.getElementById("reden");
  const foutDiv = document.getElementById("etdFoutmelding");
  const submitBtn = this.querySelector('button[type="submit"]');

  // Reset randen en foutmelding
  etdDateField.style.border = "";
  etdTimeField.style.border = "";
  tijdvakField.style.border = "";
  redenField.style.border = "";
  foutDiv.style.display = "none";

  let hasError = false;

  // Validatie: minimaal datum √≥f reden verplicht
  if (!etdDateField.value && !redenField.value) {
    etdDateField.style.border = "2px solid red";
    foutDiv.textContent = "Vul eerst een datum in √≥f kies een reden waarom geen ETD.";
    foutDiv.style.display = "block";
    etdDateField.classList.add("shake");
    hasError = true;
  } else if (etdDateField.value && !etdTimeField.value && !tijdvakField.value && !redenField.value) {
    etdTimeField.style.border = "2px solid red";
    tijdvakField.style.border = "2px solid red";
    foutDiv.textContent = "Vul een tijd in of kies een tijdvak.";
    foutDiv.style.display = "block";
    etdTimeField.classList.add("shake");
    tijdvakField.classList.add("shake");
    hasError = true;
  }

  if (hasError) {
    // Verwijder shake na korte tijd
    setTimeout(() => {
      etdDateField.classList.remove("shake");
      etdTimeField.classList.remove("shake");
      tijdvakField.classList.remove("shake");
    }, 700);
    if (submitBtn) submitBtn.disabled = false;
    return;
  }

  // Zet submitknop uit tegen dubbelklikken
  if (submitBtn) submitBtn.disabled = true;

  // Laatst verzonden throttle
  const nu = Date.now();
  const tijdSindsLaatste = nu - laatstVerzonden;
  if (tijdSindsLaatste < 60000) {
    foutDiv.textContent = "Het formulier is al verzonden. Wacht even voordat je opnieuw verzendt.";
    foutDiv.style.display = "block";
    if (submitBtn) submitBtn.disabled = false;
    return;
  }
  laatstVerzonden = nu;

  // Stel 'etd' samen voor verzending naar backend
  let etd = '';
  if (etdDateField.value && etdTimeField.value) {
    etd = `${etdDateField.value}T${etdTimeField.value}`;
  } else if (etdDateField.value && tijdvakField.value) {
    etd = `${etdDateField.value} (E:${tijdvakField.value})`;
  } else if (etdDateField.value) {
    etd = etdDateField.value;
  }

  // Data verzamelen en versturen (zoals in jouw code)
  const data = {
    scheepsnaam: document.getElementById("huidigSchipSelect").value,
    scheepsnaamHandmatig: document.getElementById("handmatigSchip").value,
    etd,
    reden: redenField.value.trim(),
    toelichting: document.getElementById("toelichting").value.trim(),
    Status: document.getElementById('berichtTypeValue').value,
    timestamp: new Date().toISOString(),
    naam: localStorage.getItem("userName") || ""
  };

  // CSV en backend hetzelfde als bij jou...
  function escapeCSV(value) {
    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
      return `"${value.replace(/"/g, '""')}"`;
    }
    return value;
  }

  const csv = `Scheepsnaam,ScheepsnaamHandmatig,ETD,RedenGeenETD,Toelichting,Status,Type_naam,Lengte,Timestamp,Latitude,Longitude,Naam\n` +
    `${escapeCSV(data.scheepsnaam)},${escapeCSV(data.scheepsnaamHandmatig)},${escapeCSV(data.etd)},` +
    `${escapeCSV(data.reden)},${escapeCSV(data.toelichting)},${escapeCSV(data.Status)},,,${escapeCSV(data.timestamp)},,,${escapeCSV(localStorage.getItem("userName") || "")}`;

  const onderwerp = data.etd
    ? `ETD Positive, ${data.scheepsnaam}, ${data.timestamp}`
    : `ETD Negative, ${data.scheepsnaam}, ${data.timestamp}`;

  // Verstuur naar backend
  const res = await fetch("/api/verstuur", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ csv, onderwerp })
  });

  if (res.ok) {
    document.getElementById("bevestiging").style.display = "block";
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(() => location.reload(), 30000);
    vuurConfettiSerie && vuurConfettiSerie();
    toonWistJeDat();
  } else {
    foutDiv.textContent = "‚ùå Fout bij verzenden";
    foutDiv.style.display = "block";
  }

  if (submitBtn) submitBtn.disabled = false;
});


function vuurConfettiSerie() {
  var duration = 2 * 1000;
  var animationEnd = Date.now() + duration;
  var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };

  function randomInRange(min, max) {
    return Math.random() * (max - min) + min;
  }

  var interval = setInterval(function() {
    var timeLeft = animationEnd - Date.now();
    if (timeLeft <= 0) return clearInterval(interval);

    var particleCount = 50 * (timeLeft / duration);
    confetti(Object.assign({}, defaults, {
      particleCount,
      origin: {
        x: randomInRange(0.1, 0.9),
        y: Math.random() - 0.2
      }
    }));
  }, 200);
}




async function vulAutoAan() {
  try {
    const res = await fetch("/api/schepen");
    const schepen = await res.json();
    const lijst = document.getElementById("schiplijst");
    lijst.innerHTML = "";
    schepen.forEach(s => {
      if (s.naam) {
        const opt = document.createElement("option");
        opt.value = s.naam;
        lijst.appendChild(opt);
      }
    });
  } catch (err) {
    console.error("Auto-aanvul fout:", err);
  }
}
  
window.addEventListener("DOMContentLoaded", vulAutoAan);

document.getElementById("handmatigSchip").addEventListener("input", function () {
  document.getElementById("huidigSchipSelect").value = ""; // reset dropdown keuze
});


</script><script>
function forceerGPSLaad() {
  if (!("geolocation" in navigator)) {
    setSelectAndGPS(true);
    const foutDiv = document.getElementById("gpsFoutmelding");
    foutDiv.innerText = "‚ö†Ô∏è Locatie niet beschikbaar, vul handmatig in.";
    foutDiv.style.display = "block";
    if (typeof vulAutoAan === "function") vulAutoAan();
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (geo) => {
      const lat = geo.coords.latitude;
      const lon = geo.coords.longitude;
      try {
        const res = await fetch("/api/schepen");
        const schepen = await res.json();
        // ...verder zoals je al had...
        setSelectAndGPS(false);
      } catch (err) {
        setSelectAndGPS(true);
        const foutDiv = document.getElementById("gpsFoutmelding");
        foutDiv.innerText = "‚ö†Ô∏è Fout bij ophalen schepen, vul handmatig in.";
        foutDiv.style.display = "block";
        const handmatig = document.getElementById("handmatigSchip");
        handmatig.disabled = false;
        if (typeof vulAutoAan === "function") vulAutoAan();
      }
    },
    (err) => {
      setSelectAndGPS(true);
      const foutDiv = document.getElementById("gpsFoutmelding");
      foutDiv.innerText = "‚ö†Ô∏è Locatie niet toegestaan, vul handmatig in.";
      foutDiv.style.display = "block";
      const handmatig = document.getElementById("handmatigSchip");
      handmatig.disabled = false;
      if (typeof vulAutoAan === "function") vulAutoAan();
    }
  );
}
</script><script>
// IDs van velden
const selectField = document.getElementById("huidigSchipSelect");
const manualField = document.getElementById("handmatigSchip");
const gpsButton = document.getElementById("gpsButton");

// Helper om select en gps (de)activeren en transparantie zetten
function setSelectAndGPS(disabled) {
    selectField.disabled = disabled;
    gpsButton.disabled = disabled;
    selectField.style.opacity = disabled ? "0.5" : "1";
    gpsButton.style.opacity = disabled ? "0.5" : "1";
}

// Direct na laden: handmatige veld altijd actief
window.addEventListener("DOMContentLoaded", function() {
    if (manualField) manualField.disabled = false;
    setSelectAndGPS(false);


});

// Wanneer je in het handmatige veld typt
manualField && manualField.addEventListener("input", function() {
    if (manualField.value.trim() !== "") {
        setSelectAndGPS(true);
        selectField.value = "";
    } else {
        // Alleen weer activeren als er w√©l schepen geladen zijn (dus niet als nog 'Laden...')
        if (selectField && (!selectField.options.length || !selectField.options[0].textContent.includes('Laden'))) {
            setSelectAndGPS(false);
        }
    }
});

// Zorg dat handmatige veld zijn datalist-link houdt
if (manualField) manualField.disabled = false;

</script>

<script>
document.getElementById("etdTijdvak").addEventListener("change", function () {
  const tijdvak = this.value;
  const etdField = document.getElementById("etd");
  const foutmelding = document.getElementById("etdFoutmelding");

  if (tijdvak && !etdField.value.trim()) {
    // Reset selectie terug naar beginoptie
    this.value = "";

    // Toon foutmelding + rode rand + shake
    etdField.style.border = "2px solid red";
    etdField.classList.add("shake");
    foutmelding.style.display = "block";

    // Shake stoppen
    setTimeout(() => etdField.classList.remove("shake"), 2000);

    // Verwijder foutmelding na 4s
    setTimeout(() => {
      foutmelding.style.display = "none";
      etdField.style.border = "";
    }, 4000);

    // Probeer picker te openen op niet-iOS
    setTimeout(() => {
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) || 
                    (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

      if (!isIOS) {
        etdField.blur();
        setTimeout(() => {
          etdField.focus();
          if (etdField.showPicker) etdField.showPicker();
        }, 200);
      }
    }, 50);
  }
});
</script>



<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker geregistreerd:', reg.scope))
        .catch(err => console.warn('‚ùå Service Worker fout:', err));
    });
  }
</script>


<script>
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      location.reload();
    }
  });
</script>


<div id="infoModal"
     style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.38);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:24px 18px 16px 18px;border-radius:18px;max-width:400px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;">
    <button id="closeModal" type="button"
            style="position:absolute;top:10px;right: -150px;font-size:22px;color:#003b5c;background:none;border:none;cursor:pointer;font-weight:bold;line-height:1;">&times;</button>
    <h2 style="font-size:1.18rem;font-weight:700;margin-bottom:8px;color:#2563eb;">Informatie</h2>
    <p style="color:#28323c;">
      Deze app is onderdeel van een MMP14-onderzoek en onderzoekt
    de waarde van het opvragen van de ETD bij de kapitein van een binnenkomend of verhalend schip.<br><br>
      Scheepsnaam wordt doormiddel van GPS locatie automatisch gezocht.
      Mocht de voorgestelde scheepsnaam niet kloppen dan kan hij handmatig ingevuld worden. <br><br>
      
      Check: <b>Scheepsnaam, ETD of Reden geen ETD, Type reis: Binnenkomend of Verhalend.</b><br><br>
      Bedankt voor uw bijdrage!
    </p>
  </div>
</div>

<!-- Popup voor push toestemming -->
<div id="pushModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.65);z-index:5000;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:24px 18px;border-radius:18px;max-width:420px;width:92vw;position:relative;box-shadow:0 4px 24px #003b5c33;text-align:center;">
    <h2 style="font-size:1.2rem;font-weight:700;margin-bottom:12px;color:#2563eb;">Schakel push notificaties in</h2>
    <p style="color:#28323c;font-size:1rem;margin-bottom:1rem;">
      Wil je meldingen ontvangen als er belangrijke updates zijn? Klik hieronder om push notificaties toe te staan.
    </p>
    <button id="pushAllowBtn" style="background:#2563eb;color:white;padding:0.7rem 1.2rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-right:8px;">Ja, inschakelen</button>
    <button id="pushDeclineBtn" style="background:#ccc;color:#333;padding:0.7rem 1.2rem;border:none;border-radius:8px;cursor:pointer;">Nee, bedankt</button>
  </div>
</div>

<script>
  // Info popup
  document.getElementById('infoButton').onclick = function(e) {
    e.preventDefault();
    document.getElementById('infoModal').style.display = 'flex';
  };
  document.getElementById('closeModal').onclick = function() {
    document.getElementById('infoModal').style.display = 'none';
  };
  // Toggle switch
  const typeSwitch = document.getElementById('typeSwitch');
  const switchDot = document.getElementById('switchDot');
  const berichtTypeValue = document.getElementById('berichtTypeValue');
  const verhalendLabel = document.getElementById('verhalendLabel');
  const binnenkomendLabel = document.getElementById('binnenkomendLabel');
  function updateToggleUI() {
    if(typeSwitch.checked) {
      switchDot.style.left = '22px';
      berichtTypeValue.value = 'Verhalend';
      verhalendLabel.style.fontWeight = 'bold';
      verhalendLabel.style.color = '#85d678';
      binnenkomendLabel.style.color = '#f8f9fa';
      binnenkomendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '.5';
      verhalendLabel.style.opacity = '1';
    
    } else {
      switchDot.style.left = '2px';
      berichtTypeValue.value = 'Binnenkomend';
      binnenkomendLabel.style.fontWeight = 'bold';
      binnenkomendLabel.style.color = '#85d678';
      verhalendLabel.style.color = '#f8f9fa';
      verhalendLabel.style.fontWeight = 'normal';
      binnenkomendLabel.style.opacity = '1';
      verhalendLabel.style.opacity = '.5';
    }
  }
  typeSwitch.onchange = updateToggleUI;
  updateToggleUI();
</script>
<script>
(function() {
  const agreed = localStorage.getItem("policyAgreed");
  const modal = document.getElementById("policyModal");
  const agreeBtn = document.getElementById("policyAgreeBtn");
  const nameInput = document.getElementById("policyNameInput");
  const errorDiv = document.getElementById("policyError");
  const form = document.getElementById("etdForm");
  const params = new URLSearchParams(window.location.search);

  function showModal() {
    modal.style.display = "flex";
    if (form) form.style.filter = "blur(2px)";
    document.body.style.overflow = "hidden";
  }
  function hideModal() {
    modal.style.display = "none";
    if (form) form.style.filter = "";
    document.body.style.overflow = "";
  }

  function startNaAkkoord() {
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = false);
    laadSchepen();

  }

  
  if (!agreed && !params.get("consent")) {
    showModal();
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);

    agreeBtn.onclick = async function() {
      const name = nameInput.value.trim();
      if (!name) {
        errorDiv.style.display = "block";
        return;
      }
      localStorage.setItem("policyAgreed", "1");
      localStorage.setItem("policyAgreedTime", Date.now().toString());
      vraagNotificationToestemming();
      localStorage.setItem("userName", name);
      hideModal();
      startNaAkkoord();
      await new Promise(r => setTimeout(r, 100));

      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
      }
      // location.reload();
    };
  } else if (!params.get("consent")) {
  
    startNaAkkoord();
  }
})();

(function() {
  const params = new URLSearchParams(window.location.search);
  const showFullPrivacy = params.get("consent") === "1";
  const fullPrivacyModal = document.getElementById("fullPrivacyModal");
  const policyModal = document.getElementById("policyModal");
  const form = document.getElementById("etdForm");

  if (showFullPrivacy) {
    fullPrivacyModal.style.display = "flex";
    policyModal.style.display = "none";
    if (form) form.style.filter = "blur(2px)";
    document.body.style.overflow = "hidden";
    if (form) form.querySelectorAll("input,select,textarea,button").forEach(el => el.disabled = true);
  }
})();

async function vraagNotificationToestemming() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    console.warn("Push notifications niet ondersteund");
    return;
  }
  const toestemming = await Notification.requestPermission();
  if (toestemming !== "granted") {
    console.log("‚ùå Gebruiker gaf geen toestemming voor notificaties");
    return;
  }

  const registration = await navigator.serviceWorker.ready;
  const subscription = await registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: "BNlpqBd4hNBtLxsbRY4ScgmprUOm2FmeBf8RjRTGcWj7bCecKsrWSs7T7LWzKZ_v0nD2b5mpG1xXenq0r66QEqs"
  });

  // Verstuur naar backend
  await fetch("/api/save-subscription", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ subscription })
  });

  console.log("‚úÖ Subscription opgeslagen");
}

</script>
<script>
  (async function() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

  const alreadyAsked = localStorage.getItem("pushAskedOnce");
  const policyAgreed = localStorage.getItem("policyAgreed");
  const agreedTime = localStorage.getItem("policyAgreedTime");

  // Als geen akkoord op privacy, stop
  if (!policyAgreed) return;

  // Check of er al een subscription is
  const registration = await navigator.serviceWorker.ready;
  const existingSub = await registration.pushManager.getSubscription();

  // Als al gevraagd of al subscribed, stop
  if (alreadyAsked || existingSub) return;

  // Check tijd sinds akkoord
  let elapsed = 0;
  if (agreedTime) {
    elapsed = Date.now() - parseInt(agreedTime, 10);
  }

  const MIN_DELAY = 5 * 60 * 1000; // 5 minuten

  // Wacht zo nodig tot 5 minuten
  const waitTime = Math.max(MIN_DELAY - elapsed, 0);
  setTimeout(() => {
    document.getElementById("pushModal").style.display = "flex";

    document.getElementById("pushAllowBtn").onclick = async () => {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        try {
          const sub = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: "BNlpqBd4hNBtLxsbRY4ScgmprUOm2FmeBf8RjRTGcWj7bCecKsrWSs7T7LWzKZ_v0nD2b5mpG1xXenq0r66QEqs"
          });

          await fetch("/api/save-subscription", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subscription: sub })
          });

          alert("‚úÖ Push notificaties zijn ingeschakeld!");
        } catch (e) {
          console.error("‚ùå Fout bij aanmelden:", e);
          alert("‚ùå Kon push notificaties niet inschakelen.");
        }
      } else {
        alert("‚ö†Ô∏è Je hebt geen toestemming gegeven.");
      }
      localStorage.setItem("pushAskedOnce", "1");
      document.getElementById("pushModal").style.display = "none";
    };

    document.getElementById("pushDeclineBtn").onclick = () => {
      localStorage.setItem("pushAskedOnce", "1");
      document.getElementById("pushModal").style.display = "none";
    };

  }, waitTime);

})();

(async function() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

  const registration = await navigator.serviceWorker.ready;
  const sub = await registration.pushManager.getSubscription();

  if (sub) {
    // Verstuur naar backend zodat hij opnieuw wordt opgeslagen
    await fetch("/api/save-subscription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ subscription: sub })
    });
    console.log("‚úÖ Subscription opnieuw geregistreerd bij backend");
  }
})();

</script>
<script>
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById("installBtn").style.display = "block";
});

document.getElementById("installBtn").addEventListener("click", async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;

  if (outcome === "accepted") {
    console.log("‚úÖ Gebruiker heeft installatie geaccepteerd");
  } else {
    console.log("‚ùå Gebruiker heeft installatie geweigerd");
  }

  document.getElementById("installBtn").style.display = "none";
  deferredPrompt = null;
});
</script>
<script>
async function toonWistJeDat() {
  try {
    const res = await fetch("/api/statistieken");
    const stats = await res.json();
    const feitjes = [
      `Wist je dat: de meeste ETD‚Äôs momenteel worden ingezonden rond <b>${stats.topLocatie}</b>?`,
      `Wist je dat: <b>${stats.pctBulk}%</b> van alle ingevulde ETD‚Äôs bulkcarriers betreft?`,
      `Wist je dat: <b>${stats.pctContainer}%</b> van de ETD‚Äôs wordt gemeld voor containerschepen?`,
      `Wist je dat: <b>${stats.pctKapitein}%</b> van de kapiteins een ETD heef kunnen geven?`,
      `Wist je dat: het tijdvak <b>${stats.topTijdvak}</b> het meest gekozen wordt?`
    ];
    const randomIndex = Math.floor(Math.random() * feitjes.length);
    document.getElementById("wistjedat").style.display = "block";
    document.getElementById("wistjedat").innerHTML = `<ul style="list-style: none; padding-left: 0;"><li>${feitjes[randomIndex]}</li></ul>`;
  } catch (err) {
    console.error("Kan wist-je-dat niet laden", err);
  }
}


// Roep dit aan na succesvolle submit!
</script>


</body>
</html>
